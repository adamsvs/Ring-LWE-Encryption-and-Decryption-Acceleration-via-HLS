#include "lwe.h"
#include "luts.h"
#include "stdlib.h"
#include "global.h"
#include <assert.h>
#include <stdbool.h>
#include <stdio.h>
#include <stdint.h>
#define NEW_RND_BOTTOM 1
#define NEW_RND_LARGE 32 - 9
#define NEW_RND_MID 32 - 6
#define Mconst   2401607092007494 //for q=7681
//#define Mconst 1501077717772770 //for q=12289
#define POLY_MASK_32 0xB4BCD35C
#define POLY_MASK_31 0X7A5BC2E3
#define logm  7 // log2(M)-1
typedef unsigned int uint;
//For initial values of lfsr
unsigned int lfsr32 = 0xABCDE;
unsigned int lfsr31 = 0x23456789;

uint32_t clz(uint32_t x) {//optimized version of clz original function

	#pragma HLS PIPELINE II=1
	unsigned n = 0;
	if (x <= 0x0000ffff) n += 16, x <<= 16;
	if (x <= 0x00ffffff) n +=  8, x <<= 8;
	if (x <= 0x0fffffff) n +=  4, x <<= 4;
	if (x <= 0x3fffffff) n +=  2, x <<= 2;
	if (x <= 0x7fffffff) n ++;
	return n;

}
uint16_t mod(uint32_t x) {//optimized version of original modulo function

	int a = (int) x;
	#pragma HLS PIPELINE II=1
	uint64_t lowbits = (uint64_t)((uint64_t) Mconst * a)&(uint64_t)(0xFFFFFFFFFFFFFFFF);//must be change MCONST for q=12289
	uint32_t lowbits_r =(uint32_t)lowbits;
	uint32_t lowbits_l =(uint32_t)(lowbits>>32);
	uint64_t pp1 =(uint64_t)lowbits_r*MODULUS;
	uint64_t pp2 =(uint64_t)lowbits_l*MODULUS;
	pp1 =(uint32_t)((uint64_t)pp1>>32);
	pp2= (uint64_t)(pp2+pp1);
	int ret3=(uint32_t)((uint64_t)pp2>>32);
	ret3=ret3-((MODULUS-1)&(a>>31));
	if(ret3<0)
 	ret3+=MODULUS;
	return (uint32_t) ret3;
}
void fwd_ntt2(uint16_t a[M]) {//original version of Forward NTT for n-points input

	int i, j, k, m;
	uint32_t u1, t1, u2, t2;
	uint32_t primrt, omega;
	i = 0;
	for (m = 2; m <= M/2; m = 2 * m) {
		primrt = primrt_omega_table[i];
	    omega = primrt_omega_table[i + 1];
	    i++;
	    for (j = 0; j < m; j += 2) {

	    	for (k = 0; k < M; k = k + 2 * m) {
				#pragma HLS PIPELINE II=1

	    		u1 = a[j + k];
	    		t1 = mod(omega * a[j + k + 1]);

	    		u2 = a[j + k + m];
	    		t2 = mod(omega * a[j + k + m + 1]);

	    		a[j + k] = mod(u1 + t1);
	    		a[j + k + 1] = mod(u2 + t2);

	    		a[j + k + m] = mod(u1 - t1);
	    		a[j + k + m + 1] = mod(u2 - t2);

	    	}
	    	omega = omega * primrt;
	    	omega = mod(omega);
	    }
	}

	primrt = FWD_CONST1; // mpz_set_str(primrt,"2028",10);
	omega = FWD_CONST2; // mpz_set_str(omega,"535",10);
	for (j = 0; j < M / 2; j++) {
		#pragma HLS PIPELINE II=1
	    t1 = omega * a[2 * j + 1];
	    t1 = mod(t1);
	    u1 = a[2 * j];
	    a[2 * j] = mod(u1 + t1);
	    a[2 * j + 1] = mod(u1 - t1);

	    omega = omega * primrt;
	    omega = mod(omega);
	}
}


void fwd_ntt2_flatten(uint16_t a[M]) {//first optimized version of Forward NTT with Loop Flatten technique

	int i, j, k, m,s,t,r;
	uint32_t u1, t1, u2, t2;
	uint32_t primrt, omega;
	uint16_t omega_array[]={4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,4298,6468,6468,6468,6468,6468,6468,6468,6468,6468,6468,6468,6468,6468,6468,6468,6468,6468,6468,6468,6468,6468,6468,6468,6468,6468,6468,6468,6468,6468,6468,6468,6468,1925,1925,1925,1925,1925,1925,1925,1925,1925,1925,1925,1925,1925,1925,1925,1925,1925,1925,1925,1925,1925,1925,1925,1925,1925,1925,1925,1925,1925,1925,1925,1925,849,849,849,849,849,849,849,849,849,849,849,849,849,849,849,849,7098,7098,7098,7098,7098,7098,7098,7098,7098,7098,7098,7098,7098,7098,7098,7098,527,527,527,527,527,527,527,527,527,527,527,527,527,527,527,527,5953,5953,5953,5953,5953,5953,5953,5953,5953,5953,5953,5953,5953,5953,5953,5953,2138,2138,2138,2138,2138,2138,2138,2138,2446,2446,2446,2446,2446,2446,2446,2446,2784,2784,2784,2784,2784,2784,2784,2784,5549,5549,5549,5549,5549,5549,5549,5549,2648,2648,2648,2648,2648,2648,2648,2648,5300,5300,5300,5300,5300,5300,5300,5300,6315,6315,6315,6315,6315,6315,6315,6315,97,97,97,97,97,97,97,97,3654,3654,3654,3654,675,675,675,675,6803,6803,6803,6803,4681,4681,4681,4681,7316,7316,7316,7316,3092,3092,3092,3092,5036,5036,5036,5036,5887,5887,5887,5887,4928,4928,4928,4928,5413,5413,5413,5413,5408,5408,5408,5408,2399,2399,2399,2399,5835,5835,5835,5835,1286,1286,1286,1286,7351,7351,7351,7351,1112,1112,1112,1112,1714,1714,2941,2941,695,695,4800,4800,3477,3477,584,584,6299,6299,4270,4270,2469,2469,4232,4232,1875,1875,7479,7479,6949,6949,5941,5941,1908,1908,5165,5165,693,693,5173,5173,6882,6882,6915,6915,4601,4601,6026,6026,5258,5258,2551,2551,4301,4301,528,528,1381,1381,7438,7438,3074,3074,2774,2774,4957,4957,1080,1080,5118,550,5618,4959,4540,707,5881,2562,5417,6090,7462,1003,6279,1125,319,1415,5795,1097,6094,6637,257,2681,1996,3099,4115,1952,4493,4640,3125,2593,4784,4149,6461,5833,4781,6688,3180,4691,
			6048,4603,1155,5653,3501,1853,3789,3901,3844,5999,5108,6453,7483,6273,6203,1438,6812,648,4608,2044,880,2844,4862,7264,7276,4801};

	uint16_t omega_array1[]={1065,4841,5013,1994,4924,7352,5998,4488,3394,3751,2799,217,4542,3250,4135,1775,5508,674,763,3086,2012,4876,7480,536,1131,4665,2922,7570,296,1771,398,1499,6244,3832,2583,793,3006,7346,6014,1885,94,4870,7496,5614,5512,5784,7619,5286,1266,4305,3882,5010,2002,7463,5702,2717,2996,2252,4236,4066,1959,2457,1129,2110,7175,6470,669,5897,2197,6943,1968,2433,1193,7060,1656,3265,4095,4442,6077,1717,542,1115,7268,6222,6451,3280,4055,7109,6646,2760,321,6825,4843,7568,5422,6024,6979,1872,2689,5631,346,4198,1607,5956,4600,535,3694,2951,2372,3916,2359,6511,3120,7042,1704,3137,1876,118,4806,2546,3452,1036,2358,1393,1406,6492,5731,5200};

	j=0;
	k=0;
	i = 0;

	for(r=0;r<logm*(M/4);r++){
		#pragma HLS PIPELINE II=1
		i=r/(M/4) + 1;
		s=r >> (logm - 1); // stage
		m = 1 << (s+1);
		t=(r - ( s << (logm - 1))) ;
		j = 2* (t>>(logm-i));
		k = (2<<i)*r % M;

		u1 = a[j + k];
		t1 = (omega_array[r] * a[j + k + 1]);

		u2 = a[j + k + m];
		t2 = (omega_array[r] * a[j + k + m + 1]);

		a[j + k] = mod(u1 + t1);
		a[j + k + 1] = mod(u2 + t2);

		a[j + k + m] = mod(u1 - t1);
		a[j + k + m + 1] = mod(u2 - t2);

	}

	for (j = 0; j < M / 2; j++) {
		#pragma HLS PIPELINE II=1
		t1 = omega_array1[j] * a[2 * j + 1];
		//t1 = mod(t1);
		u1 = a[2 * j];
		a[2 * j] = mod(u1 + t1);
		a[2 * j + 1] = mod(u1 - t1);
	}
}




void fwd_ntt_4_array_not_flatten(uint16_t out[M],uint16_t a1[M/4],uint16_t a2[M/4],uint16_t a3[M/4],uint16_t a4[M/4]) {

  int i, j, k, m;
  uint32_t u1, t1, u2, t2,u11, t11, u22, t22;
  uint32_t primrt, omega,omega1;
  i = 0;
  primrt = primrt_omega_table[i];
  omega = primrt_omega_table[i + 1];
  for (m = 0; m < M/4  ; m++){
	#pragma HLS PIPELINE II=1
    u1 = a1[m];
    t1 = mod(omega * a2[m]);
    u2 = a3[m];
    t2 = mod(omega * a4[m]);
    a1[m] = mod(u1 + t1);
    a2[m] = mod(u2 + t2);
    a3[m] = mod(u1 - t1);
    a4[m] = mod(u2 - t2);
  }
  omega = omega * primrt;
  omega = mod(omega);
  i++;
  for (m = 4; m <= M/2 ; m = 2 * m) {
	#pragma HLS PIPELINE II=1
	#pragma HLS loop_flatten
    primrt = primrt_omega_table[i];
    omega = primrt_omega_table[i + 1];
    i++;
    for (j = 0; j < m; j += 4) {
		#pragma HLS PIPELINE II=1
        omega1 = omega * primrt;
        omega1 = mod(omega1);
        for (k = 0; k < 64; k=k+m/2) {
			#pragma HLS PIPELINE II=1
        	u1 = a1[k+j/4];
        	t1 = mod(omega * a2[k+j/4]);
        	u2 = a1[k+m/4+j/4];
        	t2 = mod(omega * a2[k+m/4+j/4]);
        	a1[k+j/4] = mod(u1 + t1);
        	a2[k+j/4] = mod(u2 + t2);
        	a1[k+m/4+j/4] = mod(u1 - t1);
        	a2[k+m/4+j/4] = mod(u2 - t2);
        	u11 = a3[k+j/4];
        	t11 = mod(omega1 * a4[k+j/4]);
        	u22 = a3[k+m/4+j/4];
        	t22 = mod(omega1 * a4[k+m/4+j/4]);
        	a3[k+j/4] = mod(u11 + t11);
        	a4[k+j/4] = mod(u22 + t22);
        	a3[k+m/4+j/4] = mod(u11 - t11);
        	a4[k+m/4+j/4] = mod(u22 - t22);
        }
      omega = omega * primrt;
      omega = mod(omega);
      omega = omega * primrt;
      omega = mod(omega);
    }
  }

  primrt = FWD_CONST1; // mpz_set_str(primrt,"5118",10);
  omega = FWD_CONST2; // mpz_set_str(omega,"1065",10);
  for (j = 0; j < M / 2; j+=2) {
	#pragma HLS PIPELINE II=1
	t1 = omega * a2[j/2];
    t1 = mod(t1);
    u1 = a1[j/2];
    out[2 * j] = mod(u1 + t1);
    out[2 * j + 1] = mod(u1 - t1);

    omega1 = omega * primrt;
    omega1 = mod(omega1);
    t1 = omega1 * a4[j/2];
    t1 = mod(t1);
    u1 = a3[j/2];
    out[2 * (j+1)] = mod(u1 + t1);
    out[2 * (j+1) + 1] = mod(u1 - t1);
    omega = omega * primrt;
    omega = mod(omega);
    omega = omega * primrt;
    omega = mod(omega);
  }

}
uint16_t modorig(uint32_t x) {//original function of modulo
  int a = (int) x;
  int ret2 = (a % 7681) >= 0 ? (a % 7681) : (a % 7681) + 7681;
  while (ret2 < 0) {
    ret2 += 7681;
  }
  while (ret2 > 7681) {
    ret2 -= 7681;
  }
#ifdef DEBUG_PRINTF
  if (!(ret2 >= 0 && ret2 < MODULUS)) {
    printf("error: %d\n", ret2);
  }
#endif
  assert(ret2 >= 0 && ret2 < 7681);
  return (uint32_t) ret2;
}
void fwd_ntt_8_array(uint16_t out[256]) {//new optimized version of Forward NTT for n=256 points

  int i, j, k, m,r,s,t,ii;
  uint32_t u1, t1, u2, t2,u11, t11, u22, t22;

  uint16_t a1[32],a2[32],a3[32],a4[32],a5[32],a6[32],a7[32],a8[32];
  //uint16_t omega_array3[320]={849,7098,527,5953,849,7098,527,5953,849,7098,527,5953,849,7098,527,5953,849,7098,527,5953,849,7098,527,5953,849,7098,527,5953,849,7098,527,5953,849,7098,527,5953,849,7098,527,5953,849,7098,527,5953,849,7098,527,5953,849,7098,527,5953,849,7098,527,5953,849,7098,527,5953,849,7098,527,5953,2138,2446,2784,5549,2138,2446,2784,5549,2138,2446,2784,5549,2138,2446,2784,5549,2138,2446,2784,5549,2138,2446,2784,5549,2138,2446,2784,5549,2138,2446,2784,5549,2648,5300,6315,97,2648,5300,6315,97,2648,5300,6315,97,2648,5300,6315,97,2648,5300,6315,97,2648,5300,6315,97,2648,5300,6315,97,2648,5300,6315,97,3654,675,6803,4681,3654,675,6803,4681,3654,675,6803,4681,3654,675,6803,4681,7316,3092,5036,5887,7316,3092,5036,5887,7316,3092,5036,5887,7316,3092,5036,5887,4928,5413,5408,2399,4928,5413,5408,2399,4928,5413,5408,2399,4928,5413,5408,2399,5835,1286,7351,1112,5835,1286,7351,1112,5835,1286,7351,1112,5835,1286,7351,1112,1714,2941,695,4800,1714,2941,695,4800,3477,584,6299,4270,3477,584,6299,4270,2469,4232,1875,7479,2469,4232,1875,7479,6949,5941,1908,5165,6949,5941,1908,5165,693,5173,6882,6915,693,5173,6882,6915,4601,6026,5258,2551,4601,6026,5258,2551,4301,528,1381,7438,4301,528,1381,7438,3074,2774,4957,1080,3074,2774,4957,1080,5118,550,5618,4959,4540,707,5881,2562,5417,6090,7462,1003,6279,1125,319,1415,5795,1097,6094,6637,257,2681,1996,3099,4115,1952,4493,4640,3125,2593,4784,4149,6461,5833,4781,6688,3180,4691,6048,4603,1155,5653,3501,1853,3789,3901,3844,5999,5108,6453,7483,6273,6203,1438,6812,648,4608,2044,880,2844,4862,7264,7276,4801};
  uint16_t omega_array3[]={7098,6832,1728,527,7098,6832,1728,527,7098,6832,1728,527,7098,6832,1728,527,7098,6832,1728,527,7098,6832,1728,527,7098,6832,1728,527,7098,6832,1728,527,7098,6832,1728,527,7098,6832,1728,527,7098,6832,1728,527,7098,6832,1728,527,7098,6832,1728,527,7098,6832,1728,527,7098,6832,1728,527,7098,6832,1728,527,5235,5033,7584,2784,5235,5033,7584,2784,5235,5033,7584,2784,5235,5033,7584,2784,5235,5033,7584,2784,5235,5033,7584,2784,5235,5033,7584,2784,5235,5033,7584,2784,5300,5543,2132,1366,5300,5543,2132,1366,5300,5543,2132,1366,5300,5543,2132,1366,5300,5543,2132,1366,5300,5543,2132,1366,5300,5543,2132,1366,5300,5543,2132,1366,5413,1846,1112,6803,5413,1846,1112,6803,5413,1846,1112,6803,5413,1846,1112,6803,4589,4928,5282,7351,4589,4928,5282,7351,4589,4928,5282,7351,4589,4928,5282,7351,675,365,5887,2273,675,365,5887,2273,675,365,5887,2273,675,365,5887,2273,1286,3654,3000,5036,1286,3654,3000,5036,1286,3654,3000,5036,1286,3654,3000,5036,3449,4607,5165,6986,3449,4607,5165,6986,1655,2469,7438,5773,1655,2469,7438,5773,2941,4601,3411,6300,2941,4601,3411,6300,5941,5967,766,6299,5941,5967,766,6299,528,732,6601,6882,528,732,6601,6882,7097,3380,7479,4957,7097,3380,7479,4957,2508,3477,2551,5806,2508,3477,2551,5806,4907,693,2881,2423,4907,693,2881,2423,2028,4862,1415,2900,1438,5417,3041,3844,550,7424,4603,6801,6556,6461,1408,1800,1952,3892,4801,6094,2990,4608,1003,2897,6453,4540,4582,3501,417,1886,6688,869,1591,3125,1682,2063,2681,6526,2844,319,1848,6203,2562,3188,3901,5118,1044,6048,5637,1402,4149,198,6974,4115,5828,7276,1097,4501,648,7462,5088,5108,4959,5685};
  //uint16_t omega_array4[]={1065,4841,5013,1994,4924,7352,5998,4488,3394,3751,2799,217,4542,3250,4135,1775,5508,674,763,3086,2012,4876,7480,536,1131,4665,2922,7570,296,1771,398,1499,6244,3832,2583,793,3006,7346,6014,1885,94,4870,7496,5614,5512,5784,7619,5286,1266,4305,3882,5010,2002,7463,5702,2717,2996,2252,4236,4066,1959,2457,1129,2110,7175,6470,669,5897,2197,6943,1968,2433,1193,7060,1656,3265,4095,4442,6077,1717,542,1115,7268,6222,6451,3280,4055,7109,6646,2760,321,6825,4843,7568,5422,6024,6979,1872,2689,5631,346,4198,1607,5956,4600,535,3694,2951,2372,3916,2359,6511,3120,7042,1704,3137,1876,118,4806,2546,3452,1036,2358,1393,1406,6492,5731,5200};
  uint16_t omega_array4[]={535,1959,1775,4992,218,4287,6825,7619,4841,1230,5796,2358,4442,6244,4544,5713,3016,2372,2110,763,3483,4685,7464,5422,4305,4924,572,185,6492,542,793,2875,621,7385,6511,669,4876,3081,3615,3546,1872,2002,4488,7360,1897,6616,6222,6014,6645,3586,6182,1704,6943,1131,4730,6552,7007,346,2717,2799,113,6415,5687,4055,4870,6275,5964,5098,118,1193,7570,5322,1211,5669,5956,4236,3250,702,2671,1683,2760,5512,2481,413,335,3452,3265,398,639,5484,7145,3694,2457,5508,2050,1979,3930,4843,5286,5013,4401,7587,1393,6077,3832,5805,5248,4759,3916,7175,3086,6074,5429,3139,6024,3882,7352,1035,2067,5731,1115,3006,5135,6025,5910,3120,5897,7480};

  for(ii=0;ii<M;ii=ii+8){//Array partitioned part (Stage Array Partitioning
	#pragma HLS PIPELINE II=1
	a1[ii/8]=out[ii];
	a2[ii/8]=out[ii+1];
	a3[ii/8]=out[ii+2];
	a4[ii/8]=out[ii+3];
	a5[ii/8]=out[ii+4];
	a6[ii/8]=out[ii+5];
	a7[ii/8]=out[ii+6];
	a8[ii/8]=out[ii+7];
  }

  for (m = 0; m < 32  ; m++){ //Stage 1 (m=2) that is special case
	#pragma HLS PIPELINE II=1
    u1 = a1[m];
    t1 = (3383 * a2[m]);
    u2 = a3[m];
    t2 = (3383 * a4[m]);
    u11 = a5[m];
    t11 = (3383 * a6[m]);
    u22 = a7[m];
    t22 = (3383 * a8[m]);

    a1[m] = mod(u1 + t1);
    a2[m] = mod(u2 + t2);
    a3[m] = mod(u1 - t1);
    a4[m] = mod(u2 - t2);
    a5[m] = mod(u11 + t11);
    a6[m] = mod(u22 + t22);
    a7[m] = mod(u11 - t11);
    a8[m] = mod(u22 - t22);
  }


  for (k = 0; k < 32  ; k++){//Stage 2 (m=4) that is special case
	#pragma HLS PIPELINE II=1
    u1 = a1[k];
    t1 = (1925 * a2[k]);
    u2 = a5[k];
    t2 = (1925 * a6[k]);
    a1[k] = mod(u1 + t1);
    a2[k] = mod(u2 + t2);
    a5[k] = mod(u1 - t1);
    a6[k] = mod(u2 - t2);
    u11 = a3[k];
    t11 = (6468 * a4[k]);
    u22 = a7[k];
    t22 = (6468 * a8[k]);
    a3[k] = mod(u11 + t11);
    a4[k] = mod(u22 + t22);
    a7[k] = mod(u11 - t11);
    a8[k] = mod(u22 - t22);
  }
  for(r=0;r<80;r++){//Stage 3 (m=8 - m=128)
 	 #pragma HLS PIPELINE II=1
 	 s=r >> (4); // stage
 	 m = 1 << (s);
 	 t=(r - ( s << (4))) ;
 	 j = 2* (t>>(4-(r/16)));
 	 k = 2*m*(r%(16/m))+(j/2);
 	 i=k+m;

 	 u1 = a1[k];
 	 t1 = (omega_array3[4*r] * a2[k]);
     u2 = a1[i];
     t2 = (omega_array3[4*r] * a2[i]);
     a1[k] = mod(u1 + t1);
     a2[k] = mod(u2 + t2);
     a1[i] = mod((u1 - t1));
     a2[i] = mod((u2 - t2));
     u1 = a3[k];
     t1 =(omega_array3[4*r+1] * a4[k]);
     u2 = a3[i];
     t2 = (omega_array3[4*r+1] * a4[i]);
     a3[k] = mod(u1 + t1);
     a4[k] = mod(u2 + t2);
     a3[i] = mod((u1 - t1));
     a4[i] = mod((u2 - t2));
     u1 = a5[k];
     t1 = (omega_array3[4*r+2] * a6[k]);
     u2 = a5[i];
     t2 = (omega_array3[4*r+2] * a6[i]);
     a5[k] = mod(u1 + t1);
     a6[k] = mod(u2 + t2);
     a5[i] = mod((u1 - t1));
     a6[i] = mod((u2 - t2));
     u1 = a7[k];
     t1 = (omega_array3[4*r+3] * a8[k]);
     u2 = a7[i];
     t2 = (omega_array3[4*r+3] * a8[i]);
     a7[k] = mod(u1 + t1);
     a8[k] = mod(u2 + t2);
     a7[i] = mod((u1 - t1));
     a8[i] = mod((u2 - t2));
  }
  for (j = 0; j < 128; j+=4) {//Stage 4 (m=256)
	#pragma HLS PIPELINE II=1
	t1 = omega_array4[j] * a2[j/4];
    u1 = a1[j/4];
    out[2 * j] = mod(u1 + t1);
    out[2 * j + 1] = mod(u1 - t1);

    t1 = omega_array4[j+1] * a4[j/4];
    u1 = a3[j/4];
    out[2 * (j+1)] = mod(u1 + t1);
    out[2 * (j+1) + 1] = mod(u1 - t1);

    t1 = omega_array4[j+2] * a6[j/4];
    u1 = a5[j/4];
    out[2 * (j)+4] = mod(u1 + t1);
    out[2 * (j) + 5] = mod(u1 - t1);

    t1 = omega_array4[j+3] * a8[j/4];
    u1 = a7[j/4];
    out[2 * (j)+6] = mod(u1 + t1);
    out[2 * (j) + 7] = mod(u1 - t1);
  }
}
void fwd_ntt_8_array_512points(uint16_t out[512]) {

  int i, j, k, m,r,s,t,ii;
  uint32_t u1, t1, u2, t2,u11, t11, u22, t22;

  uint16_t a1[64],a2[64],a3[64],a4[64],a5[64],a6[64],a7[64],a8[64];
  for(ii=0;ii<M;ii=ii+8){
	  a1[ii/8]=out[ii];
	  a2[ii/8]=out[ii+1];
	  a3[ii/8]=out[ii+2];
	  a4[ii/8]=out[ii+3];
	  a5[ii/8]=out[ii+4];
	  a6[ii/8]=out[ii+5];
	  a7[ii/8]=out[ii+6];
	  a8[ii/8]=out[ii+7];
  }
  uint16_t omega_array3[]={4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,7311,3006,5023,2625,7311,3006,5023,2625,7311,3006,5023,2625,7311,3006,5023,2625,7311,3006,5023,2625,7311,3006,5023,2625,7311,3006,5023,2625,7311,3006,5023,2625,8961,563,5728,4821,8961,563,5728,4821,8961,563,5728,4821,8961,563,5728,4821,8961,563,5728,4821,8961,563,5728,4821,8961,563,5728,4821,8961,563,5728,4821,10938,9545,6461,11340,10938,9545,6461,11340,10938,9545,6461,11340,10938,9545,6461,11340,10938,9545,6461,11340,10938,9545,6461,11340,10938,9545,6461,11340,10938,9545,6461,11340,5777,9314,4591,2639,5777,9314,4591,2639,5777,9314,4591,2639,5777,9314,4591,2639,5777,9314,4591,2639,5777,9314,4591,2639,5777,9314,4591,2639,5777,9314,4591,2639,12149,8736,2963,9275,12149,8736,2963,9275,12149,8736,2963,9275,12149,8736,2963,9275,11112,9542,9198,1170,11112,9542,9198,1170,11112,9542,9198,1170,11112,9542,9198,1170,726,11227,2366,7203,726,11227,2366,7203,726,11227,2366,7203,726,11227,2366,7203,2768,9154,11289,955,2768,9154,11289,955,2768,9154,11289,955,2768,9154,11289,955,1853,4805,7393,3201,1853,4805,7393,3201,1853,4805,7393,3201,1853,4805,7393,3201,4255,4846,12208,9970,4255,4846,12208,9970,4255,4846,12208,9970,4255,4846,12208,9970,4611,2294,9238,10963,4611,2294,9238,10963,4611,2294,9238,10963,4611,2294,9238,10963,1635,8577,7969,11499,1635,8577,7969,11499,1635,8577,7969,11499,1635,8577,7969,11499,8340,12144,8011,9048,8340,12144,8011,9048,11336,10530,480,6534,11336,10530,480,6534,6915,2731,10908,9005,6915,2731,10908,9005,5067,3382,5791,334,5067,3382,5791,334,2396,8652,5331,3289,2396,8652,5331,3289,6522,8595,1022,4388,6522,8595,1022,4388,130,6378,4177,5092,130,6378,4177,5092,12171,4231,9821,1428,12171,4231,9821,1428,8993,6747,1673,11560,8993,6747,1673,11560,3748,3707,9447,4632,3748,3707,9447,4632,2837,8357,9764,9408,2837,8357,9764,9408,10092,355,11745,2426,10092,355,11745,2426,4452,3459,7300,10276,4452,3459,7300,10276,11462,5179,12280,1260,11462,5179,12280,1260,7935,7399,8705,10200,7935,7399,8705,10200,9813,2548,11950,10593,9813,2548,11950,10593,3400,5277,3271,10849,9042,4976,12176,3833,3531,4096,9509,4143,8241,9852,1426,9377,9273,2143,4414,7205,8779,11287,12129,5101,10111,10911,9984,8585,3186,2422,8653,5012,5191,11082,10600,9223,2969,11414,2166,11899,3985,5444,7394,12047,9405,9302,10512,354,3000,11885,10115,7404,9424,8005,7852,9888,6730,4337,4053,7270,10163,2187,2704,1045,2399,1168,8232,8526,2686,10682,4919,3778,11813,11796,5195,7575,10040,8643,7635,6591,243,11224,2847,1632,6957,5011,9140,11222,10745,1912,7247,2678,5407,6039,4938,2481,9153,9041,8925,27,3978,8509,8374,773,7384,2381,10805,10752,11136,6267,1663,7428,671,4645,4372,1017,2370,5088,3,442,11869,11854,9644,11744,1630,2566,5291,9430};
  uint16_t omega_array4[]={10302,3150,6281,9407,7822,1404,5468,10232,10930,64,8687,5333,5925,3329,431,3009,6152,922,1105,8855,11239,6099,5057,1489,11821,6370,4782,453,4075,5297,6415,10314,7083,8049,11286,6142,3789,3728,5241,350,10256,6507,3600,156,1973,10695,12138,2738,6427,1958,8851,9928,9606,8527,2049,11026,6950,10542,8076,4774,10120,11089,12237,7535,8724,8243,7280,1954,7540,1146,787,9087,1254,11606,421,5876,8775,9597,2505,723,400,8210,5681,9381,5445,5766,3445,1583,11907,3834,9260,11871,4324,3956,6234,9364,9090,11454,12048,3963,5456,6299,9162,10474,10367,2948,7665,8320,11011,5106,8332,2655,6874,10211,975,9259,8471,8273,10968,6374,6093,9235,605,4737,7210,9734,1323,426,10587,1319,11404,1805,4789,11964,1010,5369,5435,8633,6068,10258,1018,7991,10710,1693,4948,11848,12147,8760,7753,295,7591,2500,8301,7856,6403,6381,5315,6170,677,3757,5529,8719,3532,2447,147,8240,9369,1512,3998,1566,3263,9522,5574,1962,10162,6421,6136,7967,2844,10446,1190,2919,7377,12240,5446,9166,11785,6860,11767,7105,9115,10431,11635,709,1956,2051,5537,11341,8807,7796,11316,9830,8209,2281,1041,168,5906,174,1728,1058,8812,218,3860,11637,7509,6347,316,5257,5594,8517,4916,1360,3336,11942,12233,6224,12231,11713,7840,1159,8120,6906,8410,9786,6077,3991,2344,6328,9450,6554,3643,11177,4212,4115,6118,8212,192,1483,3710,5486,9987,1293,9027,6167,2766,3315};
  for (m = 0; m < 64  ; m++){
	#pragma HLS PIPELINE II=1
    u1 = a1[m];
    t1 = (1479 * a2[m]);
    u2 = a3[m];
    t2 = (1479 * a4[m]);
    u11 = a5[m];
    t11 = (1479 * a6[m]);
    u22 = a7[m];
    t22 = (1479 * a8[m]);
    a1[m] = mod(u1 + t1);
    a2[m] = mod(u2 + t2);
    a3[m] = mod(u1 - t1);
    a4[m] = mod(u2 - t2);
    a5[m] = mod(u11 + t11);
    a6[m] = mod(u22 + t22);
    a7[m] = mod(u11 - t11);
    a8[m] = mod(u22 - t22);
  }
  for (k = 0; k < 64  ; k++){
	#pragma HLS PIPELINE II=1
    u1 = a1[k];
    t1 = (8246 * a2[k]);
    u2 = a5[k];
    t2 = (8246 * a6[k]);
    a1[k] = mod(u1 + t1);
    a2[k] = mod(u2 + t2);
    a5[k] = mod(u1 - t1);
    a6[k] = mod(u2 - t2);
    u11 = a3[k];
    t11 = (5146 * a4[k]);
    u22 = a7[k];
    t22 = (5146 * a8[k]);
    a3[k] = mod(u11 + t11);
    a4[k] = mod(u22 + t22);
    a7[k] = mod(u11 - t11);
    a8[k] = mod(u22 - t22);
  }
  for(r=0;r<192;r++){
 	 #pragma HLS PIPELINE II=1
 	 s=r >> (5); // stage
 	 m = 1 << (s);
 	 t=(r - ( s << (5))) ;
 	 j = 2* (t>>(5-(r/32)));
 	 k = 2*m*(r%(32/m))+(j/2);
 	 i=k+m;
 	 u1 = a1[k];
     t1 = (omega_array3[4*r] * a2[k]);
     u2 = a1[i];
     t2 = (omega_array3[4*r] * a2[i]);
     a1[k] = mod(u1 + t1);
     a2[k] = mod(u2 + t2);
     a1[i] = mod(u1 - t1);
     a2[i] = mod(u2 - t2);
     u1 = a3[k];
     t1 = (omega_array3[4*r+1] * a4[k]);
     u2 = a3[i];
     t2 = (omega_array3[4*r+1] * a4[i]);
     a3[k] = mod(u1 + t1);
     a4[k] = mod(u2 + t2);
     a3[i] = mod(u1 - t1);
     a4[i] = mod(u2 - t2);
     u1 = a5[k];
     t1 = (omega_array3[4*r+2] * a6[k]);
     u2 = a5[i];
     t2 = (omega_array3[4*r+2] * a6[i]);
     a5[k] = mod(u1 + t1);
     a6[k] = mod(u2 + t2);
     a5[i] = mod(u1 - t1);
     a6[i] = mod(u2 - t2);
     u1 = a7[k];
     t1 = (omega_array3[4*r+3] * a8[k]);
     u2 = a7[i];
     t2 = (omega_array3[4*r+3] * a8[i]);
     a7[k] = mod(u1 + t1);
     a8[k] = mod(u2 + t2);
     a7[i] = mod(u1 - t1);
     a8[i] = mod(u2 - t2);
  }
  for (j = 0; j < 256; j+=4) {
	#pragma HLS PIPELINE II=1
	t1 = omega_array4[j] * a2[j/4];
    t1 = (t1);
    u1 = a1[j/4];
    out[2 * j] = mod(u1 + t1);
    out[2 * j + 1] = mod(u1 - t1);

    t1 = omega_array4[j+1] * a4[j/4];
    t1 = (t1);
    u1 = a3[j/4];
    out[2 * (j+1)] = mod(u1 + t1);
    out[2 * (j+1) + 1] = mod(u1 - t1);

    t1 = omega_array4[j+2] * a6[j/4];
    t1 = (t1);
    u1 = a5[j/4];
    out[2 * (j)+4] = mod(u1 + t1);
    out[2 * (j) + 5] = mod(u1 - t1);

    t1 = omega_array4[j+3] * a8[j/4];
    t1 = (t1);
    u1 = a7[j/4];
    out[2 * (j)+6] = mod(u1 + t1);
    out[2 * (j) + 7] = mod(u1 - t1);

  }
}
void fwd_ntt_8_array_1024points(uint16_t out[1024]) {

	int i, j, k, m,r,s,t,ii;
	uint32_t u1, t1, u2, t2,u11, t11, u22, t22;
	uint32_t primrt, omega,omega1,omega2,omega3;
	uint16_t a1[128],a2[128],a3[128],a4[128],a5[128],a6[128],a7[128],a8[128];
    for(ii=0;ii<M;ii=ii+8){
		#pragma HLS PIPELINE II=1
    	a1[ii/8]=out[ii];
    	a2[ii/8]=out[ii+1];
    	a3[ii/8]=out[ii+2];
    	a4[ii/8]=out[ii+3];
    	a5[ii/8]=out[ii+4];
    	a6[ii/8]=out[ii+5];
    	a7[ii/8]=out[ii+6];
    	a8[ii/8]=out[ii+7];
    }
    uint32_t omega_array3[]={4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,4134,11567,6553,1305,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,5860,3621,1212,8785,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,3195,9744,10643,3542,7311,3006,5023,2625,7311,3006,5023,2625,7311,3006,5023,2625,7311,3006,5023,2625,7311,3006,5023,2625,7311,3006,5023,2625,7311,3006,5023,2625,7311,3006,5023,2625,7311,3006,5023,2625,7311,3006,5023,2625,7311,3006,5023,2625,7311,3006,5023,2625,7311,3006,5023,2625,7311,3006,5023,2625,7311,3006,5023,2625,7311,3006,5023,2625,8961,563,5728,4821,8961,563,5728,4821,8961,563,5728,4821,8961,563,5728,4821,8961,563,5728,4821,8961,563,5728,4821,8961,563,5728,4821,8961,563,5728,4821,8961,563,5728,4821,8961,563,5728,4821,8961,563,5728,4821,8961,563,5728,4821,8961,563,5728,4821,8961,563,5728,4821,8961,563,5728,4821,8961,563,5728,4821,10938,9545,6461,11340,10938,9545,6461,11340,10938,9545,6461,11340,10938,9545,6461,11340,10938,9545,6461,11340,10938,9545,6461,11340,10938,9545,6461,11340,10938,9545,6461,11340,10938,9545,6461,11340,10938,9545,6461,11340,10938,9545,6461,11340,10938,9545,6461,11340,10938,9545,6461,11340,10938,9545,6461,11340,10938,9545,6461,11340,10938,9545,6461,11340,5777,9314,4591,2639,5777,9314,4591,2639,5777,9314,4591,2639,5777,9314,4591,2639,5777,9314,4591,2639,5777,9314,4591,2639,5777,9314,4591,2639,5777,9314,4591,2639,5777,9314,4591,2639,5777,9314,4591,2639,5777,9314,4591,2639,5777,9314,4591,2639,5777,9314,4591,2639,5777,9314,4591,2639,5777,9314,4591,2639,5777,9314,4591,2639,12149,8736,2963,9275,12149,8736,2963,9275,12149,8736,2963,9275,12149,8736,2963,9275,12149,8736,2963,9275,12149,8736,2963,9275,12149,8736,2963,9275,12149,8736,2963,9275,11112,9542,9198,1170,11112,9542,9198,1170,11112,9542,9198,1170,11112,9542,9198,1170,11112,9542,9198,1170,11112,9542,9198,1170,11112,9542,9198,1170,11112,9542,9198,1170,726,11227,2366,7203,726,11227,2366,7203,726,11227,2366,7203,726,11227,2366,7203,726,11227,2366,7203,726,11227,2366,7203,726,11227,2366,7203,726,11227,2366,7203,2768,9154,11289,955,2768,9154,11289,955,2768,9154,11289,955,2768,9154,11289,955,2768,9154,11289,955,2768,9154,11289,955,2768,9154,11289,955,2768,9154,11289,955,1853,4805,7393,3201,1853,4805,7393,3201,1853,4805,7393,3201,1853,4805,7393,3201,1853,4805,7393,3201,1853,4805,7393,3201,1853,4805,7393,3201,1853,4805,7393,3201,4255,4846,12208,9970,4255,4846,12208,9970,4255,4846,12208,9970,4255,4846,12208,9970,4255,4846,12208,9970,4255,4846,12208,9970,4255,4846,12208,9970,4255,4846,12208,9970,4611,2294,9238,10963,4611,2294,9238,10963,4611,2294,9238,10963,4611,2294,9238,10963,4611,2294,9238,10963,4611,2294,9238,10963,4611,2294,9238,10963,4611,2294,9238,10963,1635,8577,7969,11499,1635,8577,7969,11499,1635,8577,7969,11499,1635,8577,7969,11499,1635,8577,7969,11499,1635,8577,7969,11499,1635,8577,7969,11499,1635,8577,7969,11499,8340,12144,8011,9048,8340,12144,8011,9048,8340,12144,8011,9048,8340,12144,8011,9048,11336,10530,480,6534,11336,10530,480,6534,11336,10530,480,6534,11336,10530,480,6534,6915,2731,10908,9005,6915,2731,10908,9005,6915,2731,10908,9005,6915,2731,10908,9005,5067,3382,5791,334,5067,3382,5791,334,5067,3382,5791,334,5067,3382,5791,334,2396,8652,5331,3289,2396,8652,5331,3289,2396,8652,5331,3289,2396,8652,5331,3289,6522,8595,1022,4388,6522,8595,1022,4388,6522,8595,1022,4388,6522,8595,1022,4388,130,6378,4177,5092,130,6378,4177,5092,130,6378,4177,5092,130,6378,4177,5092,12171,4231,9821,1428,12171,4231,9821,1428,12171,4231,9821,1428,12171,4231,9821,1428,8993,6747,1673,11560,8993,6747,1673,11560,8993,6747,1673,11560,8993,6747,1673,11560,3748,3707,9447,4632,3748,3707,9447,4632,3748,3707,9447,4632,3748,3707,9447,4632,2837,8357,9764,9408,2837,8357,9764,9408,2837,8357,9764,9408,2837,8357,9764,9408,10092,355,11745,2426,10092,355,11745,2426,10092,355,11745,2426,10092,355,11745,2426,4452,3459,7300,10276,4452,3459,7300,10276,4452,3459,7300,10276,4452,3459,7300,10276,11462,5179,12280,1260,11462,5179,12280,1260,11462,5179,12280,1260,11462,5179,12280,1260,7935,7399,8705,10200,7935,7399,8705,10200,7935,7399,8705,10200,7935,7399,8705,10200,9813,2548,11950,10593,9813,2548,11950,10593,9813,2548,11950,10593,9813,2548,11950,10593,3400,5277,3271,10849,3400,5277,3271,10849,9042,4976,12176,3833,9042,4976,12176,3833,3531,4096,9509,4143,3531,4096,9509,4143,8241,9852,1426,9377,8241,9852,1426,9377,9273,2143,4414,7205,9273,2143,4414,7205,8779,11287,12129,5101,8779,11287,12129,5101,10111,10911,9984,8585,10111,10911,9984,8585,3186,2422,8653,5012,3186,2422,8653,5012,5191,11082,10600,9223,5191,11082,10600,9223,2969,11414,2166,11899,2969,11414,2166,11899,3985,5444,7394,12047,3985,5444,7394,12047,9405,9302,10512,354,9405,9302,10512,354,3000,11885,10115,7404,3000,11885,10115,7404,9424,8005,7852,9888,9424,8005,7852,9888,6730,4337,4053,7270,6730,4337,4053,7270,10163,2187,2704,1045,10163,2187,2704,1045,2399,1168,8232,8526,2399,1168,8232,8526,2686,10682,4919,3778,2686,10682,4919,3778,11813,11796,5195,7575,11813,11796,5195,7575,10040,8643,7635,6591,10040,8643,7635,6591,243,11224,2847,1632,243,11224,2847,1632,6957,5011,9140,11222,6957,5011,9140,11222,10745,1912,7247,2678,10745,1912,7247,2678,5407,6039,4938,2481,5407,6039,4938,2481,9153,9041,8925,27,9153,9041,8925,27,3978,8509,8374,773,3978,8509,8374,773,7384,2381,10805,10752,7384,2381,10805,10752,11136,6267,1663,7428,11136,6267,1663,7428,671,4645,4372,1017,671,4645,4372,1017,2370,5088,3,442,2370,5088,3,442,11869,11854,9644,11744,11869,11854,9644,11744,1630,2566,5291,9430,1630,2566,5291,9430,10302,3150,6281,9407,7822,1404,5468,10232,10930,64,8687,5333,5925,3329,431,3009,6152,922,1105,8855,11239,6099,5057,1489,11821,6370,4782,453,4075,5297,6415,10314,7083,8049,11286,6142,3789,3728,5241,350,10256,6507,3600,156,1973,10695,12138,2738,6427,1958,8851,9928,9606,8527,2049,11026,6950,10542,8076,4774,10120,11089,12237,7535,8724,8243,7280,1954,7540,1146,787,9087,1254,11606,421,5876,8775,9597,2505,723,400,8210,5681,9381,5445,5766,3445,1583,11907,3834,9260,11871,4324,3956,6234,9364,9090,11454,12048,3963,5456,6299,9162,10474,10367,2948,7665,8320,11011,5106,8332,2655,6874,10211,975,9259,8471,8273,10968,6374,6093,9235,605,4737,7210,9734,1323,426,10587,1319,11404,1805,4789,11964,1010,5369,5435,8633,6068,10258,1018,7991,10710,1693,4948,11848,12147,8760,7753,295,7591,2500,8301,7856,6403,6381,5315,6170,677,3757,5529,8719,3532,2447,147,8240,9369,1512,3998,1566,3263,9522,5574,1962,10162,6421,6136,7967,2844,10446,1190,2919,7377,12240,5446,9166,11785,6860,11767,7105,9115,10431,11635,709,1956,2051,5537,11341,8807,7796,11316,9830,8209,2281,1041,168,5906,174,1728,1058,8812,218,3860,11637,7509,6347,316,5257,5594,8517,4916,1360,3336,11942,12233,6224,12231,11713,7840,1159,8120,6906,8410,9786,6077,3991,2344,6328,9450,6554,3643,11177,4212,4115,6118,8212,192,1483,3710,5486,9987,1293,9027,6167,2766,3315};
    uint16_t omega_array4[]={10344,5969,10771,5461,180,11010,9839,1706,1942,12281,3607,9667,11667,7014,11197,6940,10767,1120,11158,10699,1057,1160,5412,11520,4167,2957,10872,1398,11777,9646,4238,9348,6492,3846,1756,904,10235,1350,8841,6203,506,2276,12229,8619,4913,7624,3449,4099,2894,874,8400,9951,364,1783,8700,3723,377,530,3744,7806,10485,8449,10900,7207,8665,11823,4267,881,6780,9173,10125,11007,3511,3795,4781,11839,9342,6125,8024,7434,20,9416,6555,1555,7043,2730,7228,3805,9489,8972,3975,3502,9389,11048,8067,8016,11041,9687,8794,1280,463,1694,1208,8348,2674,7899,10029,5135,8914,8620,2926,11024,6599,150,9175,6151,5518,9811,8186,5054,10104,3578,5845,11379,1687,2828,9126,5202,10964,2929,5063,4510,9600,9617,416,9060,1165,7766,3942,7628,7790,5410,3205,9656,8946,6481,1125,1223,3121,4518,5993,12239,1038,2046,2257,826,5464,6508,8921,7000,2148,8496,3534,7250,9247,10555,4538,3120,6505,2593,9089,4987,8054,9269,3708,5604,10975,5650,5596,2293,3028,4974,9307,1936,11914,7785,3056,10783,6195,4113,11943,11607,3344,3821,2275,1927,5219,1763,11573,9457,11111,5776,1014,578,6680,11249,1928,3232,5163,2434,5508,5103,11053,10421,438,2213,2231,3332,3087,10631,994,3451,125,9694,7174,502,10224,10918,8308,8420,7078,6919,3338,3454,6453,7605,4335,944,4489,2171,11951,8000,5966,4443,7550,3019,10568,3285,10453,10588,412,4719,12143,7455,7449,7082,11260,4649,3765,2946,8151,865,1705,3929,8881,457,1327,5386,1737,1790,7080,2945,10138,9754,10844,7878,2600,7469,4209,5526,6204,10808,5676,3090,4670,11194,612,567,3959,10716,4145,9804,9806,5832,343,6643,11034,11307,9572,3808,3528,6883,1136,3944,3654,2301,11710,7596,9929,7211,717,845,4578,9663,7326,5703,10886,10447,10221,4590,10397,11259,6636,365,12085,12100,6873,8717,6811,9021,4924,10345,3982,1882,8611,8520,5002,2827,11113,1802,7814,6878,11071,11522,193,9757,4883,5789,12050,7911,10763,9068,9847,10388,4564,614,8882,10759,4727,8536,10077,8071,68,63,9998,5287,1826,9282,2455,648,2769,3469,1226,9449,2429,3154,392,7592,5588,5900,406,4352,4032,844,6565,6263,4176,9652,4605,5170,814,4730,2575,7988,5232,510,6617,1251,8930,1406,8170,12268,4860,2334,7584,9195,3278,12073,11366,2940,7784,5043,7383,3045,8062,5662,6330,6226,3961,6742,10945,3815,1908,6105,10897,879,10754,2373,3825,6616,3238,5530,10545,12119,5987,11872,5216,7724,1373,7,10669,11511,9761,9224,7100,72,4404,11309,5598,10608,9828,11274,1409,2209,10179,2021,2776,1849,448,6921,11653,10254,464,11996,4608,11498,11014,1891,3017,2253,8774,4153,6197,139,6454,5618,7735,4094,540,8452,4939,5118,5826,12265,10821,4423,10423,8753,9013,8531,7723,3360,8896,7519,3171,3480,3947,9982,212,8871,8038,4194,10753,4360,425,3466,7187,11538,5268,2712,6127,4050};
    for (m = 0; m < 128  ; m++){
		#pragma HLS PIPELINE II=1
        u1 = a1[m];
        t1 = (1479 * a2[m]);

        u2 = a3[m];
        t2 = (1479 * a4[m]);
//
        u11 = a5[m];
        t11 = (1479 * a6[m]);

        u22 = a7[m];
        t22 = (1479 * a8[m]);
        a1[m] = mod(u1 + t1);
        a2[m] = mod(u2 + t2);

        a3[m] = mod(u1 - t1);
        a4[m] = mod(u2 - t2);
        //
        a5[m] = mod(u11 + t11);
        a6[m] = mod(u22 + t22);

        a7[m] = mod(u11 - t11);
        a8[m] = mod(u22 - t22);
    }
    for (k = 0; k < 128  ; k++){
		#pragma HLS PIPELINE II=1
    	u1 = a1[k];
    	t1 = (8246 * a2[k]);
    	u2 = a5[k];
    	t2 = (8246 * a6[k]);
    	a1[k] = mod(u1 + t1);
    	a2[k] = mod(u2 + t2);
    	a5[k] = mod(u1 - t1);
    	a6[k] = mod(u2 - t2);
    	u11 = a3[k];
    	t11 = (5146 * a4[k]);
    	u22 = a7[k];
    	t22 = (5146 * a8[k]);
    	a3[k] = mod(u11 + t11);
    	a4[k] = mod(u22 + t22);
    	a7[k] = mod(u11 - t11);
    	a8[k] = mod(u22 - t22);
    }
    for(r=0;r<448;r++){
 		#pragma HLS PIPELINE II=1
    	s=r >> (6); // stage
    	m = 1 << (s);
    	t=(r - ( s << (6))) ;
    	j = 2* (t>>(6-(r/64)));
    	k = 2*m*(r%(64/m))+(j/2);
    	i=k+m;

        u1 = a1[k];
        t1 = (omega_array3[4*r] * a2[k]);
        u2 = a1[i];
        t2 = (omega_array3[4*r] * a2[i]);
        a1[k] = mod(u1 + t1);
        a2[k] = mod(u2 + t2);
        a1[i] = mod(u1 - t1);
        a2[i] = mod(u2 - t2);
        u1 = a3[k];
        t1 = (omega_array3[4*r+1] * a4[k]);
        u2 = a3[i];
        t2 = (omega_array3[4*r+1] * a4[i]);
        a3[k] = mod(u1 + t1);
        a4[k] = mod(u2 + t2);
        a3[i] = mod(u1 - t1);
        a4[i] = mod(u2 - t2);
        u1 = a5[k];
        t1 = (omega_array3[4*r+2] * a6[k]);
        u2 = a5[i];
        t2 = (omega_array3[4*r+2] * a6[i]);
        a5[k] = mod(u1 + t1);
        a6[k] = mod(u2 + t2);
        a5[i] = mod(u1 - t1);
        a6[i] = mod(u2 - t2);
        u1 = a7[k];
        t1 = (omega_array3[4*r+3] * a8[k]);
        u2 = a7[i];
        t2 = (omega_array3[4*r+3] * a8[i]);
        a7[k] = mod(u1 + t1);
        a8[k] = mod(u2 + t2);
        a7[i] = mod(u1 - t1);
        a8[i] = mod(u2 - t2);
    }
    for (j = 0; j < 512; j+=4) {
		#pragma HLS PIPELINE II=1
    	t1 = omega_array4[j] * a2[j/4];
    	u1 = a1[j/4];
    	out[2 * j] = mod(u1 + t1);
    	out[2 * j + 1] = mod(u1 - t1);
    	t1 = omega_array4[j+1] * a4[j/4];
    	u1 = a3[j/4];
    	out[2 * (j+1)] = mod(u1 + t1);
    	out[2 * (j+1) + 1] = mod(u1 - t1);
    	t1 = omega_array4[j+2] * a6[j/4];
    	u1 = a5[j/4];
    	out[2 * (j)+4] = mod(u1 + t1);
    	out[2 * (j) + 5] = mod(u1 - t1);
    	t1 = omega_array4[j+3] * a8[j/4];
    	u1 = a7[j/4];
    	out[2 * (j)+6] = mod(u1 + t1);
    	out[2 * (j) + 7] = mod(u1 - t1);
    }
}
void fwd_ntt_16_array(uint16_t out[256]){//new version of Forward NTT for n=256 points

  int i, j, k, m,r,s,t,ii;
  uint32_t u1, t1, u2, t2,u11, t11, u22, t22;

  uint16_t a1[16],a2[16],a3[16],a4[16],a5[16],a6[16],a7[16],a8[16],a9[16],a10[16],a11[16],a12[16],a13[16],a14[16],a15[16],a16[16];
  uint16_t omega_array3[]={5235,5033,7584,2784,5300,5543,2132,1366,5235,5033,7584,2784,5300,5543,2132,1366,5235,5033,7584,2784,5300,5543,2132,1366,5235,5033,7584,2784,5300,5543,2132,1366,5235,5033,7584,2784,5300,5543,2132,1366,5235,5033,7584,2784,5300,5543,2132,1366,5235,5033,7584,2784,5300,5543,2132,1366,5235,5033,7584,2784,5300,5543,2132,1366,5413,1846,1112,6803,4589,4928,5282,7351,5413,1846,1112,6803,4589,4928,5282,7351,5413,1846,1112,6803,4589,4928,5282,7351,5413,1846,1112,6803,4589,4928,5282,7351,675,365,5887,2273,1286,3654,3000,5036,675,365,5887,2273,1286,3654,3000,5036,675,365,5887,2273,1286,3654,3000,5036,675,365,5887,2273,1286,3654,3000,5036,3449,4607,5165,6986,1655,2469,7438,5773,3449,4607,5165,6986,1655,2469,7438,5773,2941,4601,3411,6300,5941,5967,766,6299,2941,4601,3411,6300,5941,5967,766,6299,528,732,6601,6882,7097,3380,7479,4957,528,732,6601,6882,7097,3380,7479,4957,2508,3477,2551,5806,4907,693,2881,2423,2508,3477,2551,5806,4907,693,2881,2423,2028,4862,1415,2900,1438,5417,3041,3844,550,7424,4603,6801,6556,6461,1408,1800,1952,3892,4801,6094,2990,4608,1003,2897,6453,4540,4582,3501,417,1886,6688,869,1591,3125,1682,2063,2681,6526,2844,319,1848,6203,2562,3188,3901,5118,1044,6048,5637,1402,4149,198,6974,4115,5828,7276,1097,4501,648,7462,5088,5108,4959,5685};
  uint16_t omega_array4[]={535,1959,1775,4992,218,4287,6825,7619,4841,1230,5796,2358,4442,6244,4544,5713,3016,2372,2110,763,3483,4685,7464,5422,4305,4924,572,185,6492,542,793,2875,621,7385,6511,669,4876,3081,3615,3546,1872,2002,4488,7360,1897,6616,6222,6014,6645,3586,6182,1704,6943,1131,4730,6552,7007,346,2717,2799,113,6415,5687,4055,4870,6275,5964,5098,118,1193,7570,5322,1211,5669,5956,4236,3250,702,2671,1683,2760,5512,2481,413,335,3452,3265,398,639,5484,7145,3694,2457,5508,2050,1979,3930,4843,5286,5013,4401,7587,1393,6077,3832,5805,5248,4759,3916,7175,3086,6074,5429,3139,6024,3882,7352,1035,2067,5731,1115,3006,5135,6025,5910,3120,5897,7480};


  for(ii=0;ii<M;ii=ii+16){//Inp array partitioned to 16 different array  (Stage Array Partitioning
	#pragma HLS PIPELINE II=1
	a1[ii/16]=out[ii];
	a2[ii/16]=out[ii+1];
	a3[ii/16]=out[ii+2];
	a4[ii/16]=out[ii+3];
	a5[ii/16]=out[ii+4];
	a6[ii/16]=out[ii+5];
	a7[ii/16]=out[ii+6];
	a8[ii/16]=out[ii+7];
	a9[ii/16]=out[ii+8];
	a10[ii/16]=out[ii+9];
	a11[ii/16]=out[ii+10];
	a12[ii/16]=out[ii+11];
	a13[ii/16]=out[ii+12];
	a14[ii/16]=out[ii+13];
	a15[ii/16]=out[ii+14];
	a16[ii/16]=out[ii+15];
  }

  for (m = 0; m < 16  ; m++){//Stage 1 (m=2) that is special case
	#pragma HLS PIPELINE II=1
    u1 = a1[m];
    t1 = (3383 * a2[m]);
    u2 = a3[m];
    t2 = (3383 * a4[m]);
    u11 = a5[m];
    t11 = (3383 * a6[m]);
    u22 = a7[m];
    t22 = (3383 * a8[m]);
    a1[m] = mod(u1 + t1);
    a2[m] = mod(u2 + t2);
    a3[m] = mod(u1 - t1);
    a4[m] = mod(u2 - t2);
    a5[m] = mod(u11 + t11);
    a6[m] = mod(u22 + t22);
    a7[m] = mod(u11 - t11);
    a8[m] = mod(u22 - t22);
    u1 = a9[m];
    t1 = (3383 * a10[m]);
    u2 = a11[m];
    t2 = (3383 * a12[m]);
    u11 = a13[m];
    t11 = (3383 * a14[m]);
    u22 = a15[m];
    t22 = (3383 * a16[m]);
    a9[m] = mod(u1 + t1);
    a10[m] = mod(u2 + t2);
    a11[m] = mod(u1 - t1);
    a12[m] = mod(u2 - t2);
    a13[m] = mod(u11 + t11);
    a14[m] = mod(u22 + t22);
    a15[m] = mod(u11 - t11);
    a16[m] = mod(u22 - t22);
  }


  for (k = 0; k < 16  ; k++){//Stage 2(m=4) that is special case
	#pragma HLS PIPELINE II=1
    u1 = a1[k];
    t1 = (1925 * a2[k]);
    u2 = a5[k];
    t2 = (1925 * a6[k]);
    a1[k] = mod(u1 + t1);
    a2[k] = mod(u2 + t2);
    a5[k] = mod(u1 - t1);
    a6[k] = mod(u2 - t2);
    u1 = a9[k];
    t1 = (1925 * a10[k]);
    u2 = a13[k];
    t2 = (1925 * a14[k]);
    a9[k] = mod(u1 + t1);
    a10[k] = mod(u2 + t2);
    a13[k] = mod(u1 - t1);
    a14[k] = mod(u2 - t2);
    u11 = a3[k];
    t11 = (6468 * a4[k]);
    u22 = a7[k];
    t22 = (6468 * a8[k]);
    a3[k] = mod(u11 + t11);
    a4[k] = mod(u22 + t22);
    a7[k] = mod(u11 - t11);
    a8[k] = mod(u22 - t22);
    u11 = a11[k];
    t11 = (6468 * a12[k]);
    u22 = a15[k];
    t22 = (6468 * a16[k]);
    a11[k] = mod(u11 + t11);
    a12[k] = mod(u22 + t22);
    a15[k] = mod(u11 - t11);
    a16[k] = mod(u22 - t22);
  }
 for (k = 0; k < 16  ; k++){//Stage 3 (m=8) that is special case for this optimization differently from fwd_ntt_8_array
 	 #pragma HLS PIPELINE II=1
     u1 = a1[k];
     t1 = (7098 * a2[k]);
     u2 = a9[k];
     t2 = (7098 * a10[k]);
     a1[k] = mod(u1 + t1);
     a2[k] = mod(u2 + t2);
     a9[k] = mod(u1 - t1);
     a10[k] = mod(u2 - t2);
     u1 = a3[k];
     t1 = (6832 * a4[k]);
     u2 = a11[k];
     t2 = (6832 * a12[k]);
     a3[k] = mod(u1 + t1);
     a4[k] = mod(u2 + t2);
     a11[k] = mod(u1 - t1);
     a12[k] = mod(u2 - t2);
     u11 = a5[k];
     t11 = (1728 * a6[k]);
     u22 = a13[k];
     t22 = (1728 * a14[k]);
     a5[k] = mod(u11 + t11);
     a6[k] = mod(u22 + t22);
     a13[k] = mod(u11 - t11);
     a14[k] = mod(u22 - t22);
     u11 = a7[k];
     t11 = (527 * a8[k]);
     u22 = a15[k];
     t22 = (527 * a16[k]);
     a7[k] = mod(u11 + t11);
     a8[k] = mod(u22 + t22);
     a15[k] = mod(u11 - t11);
     a16[k] = mod(u22 - t22);
 }

  for(r=0;r<32;r++){//Stage 4 (m=16 - m=128)
 	 #pragma HLS PIPELINE II=1
	 s=(r) >> (3); // stage
 	 m = 1 << (s);
 	 t=(r - ( s << (3))) ;
 	 j = 2* (t>>(3-(r/8)));
 	 k = 2*m*(r%(8/m))+(j/2);
 	 i=k+m;

     u1 = a1[k];
     t1 = omega_array3[8*r] * a2[k];
     u2 = a1[i];
     t2 = omega_array3[8*r] * a2[i];
     a1[k] = mod(u1 + t1);
     a2[k] = mod(u2 + t2);
     a1[i] = mod(u1 - t1);
     a2[i] = mod(u2 - t2);
     u1 = a3[k];
     t1 = omega_array3[8*r+1] * a4[k];
     u2 = a3[i];
     t2 = omega_array3[8*r+1] * a4[i];
     a3[k] = mod(u1 + t1);
     a4[k] = mod(u2 + t2);
     a3[i] = mod(u1 - t1);
     a4[i] = mod(u2 - t2);
     u1 = a5[k];
     t1 = omega_array3[8*r+2] * a6[k];
     u2 = a5[i];
     t2 = omega_array3[8*r+2] * a6[i];
     a5[k] = mod(u1 + t1);
     a6[k] = mod(u2 + t2);
     a5[i] = mod(u1 - t1);
     a6[i] = mod(u2 - t2);
     u1 = a7[k];
     t1 = omega_array3[8*r+3] * a8[k];
     u2 = a7[i];
     t2 = omega_array3[8*r+3] * a8[i];
     a7[k] = mod(u1 + t1);
     a8[k] = mod(u2 + t2);
     a7[i] = mod(u1 - t1);
     a8[i] = mod(u2 - t2);
     u1 = a9[k];
     t1 = omega_array3[8*r+4] * a10[k];
     u2 = a9[i];
     t2 = omega_array3[8*r+4] * a10[i];
     a9[k] = mod(u1 + t1);
     a10[k] = mod(u2 + t2);
     a9[i] = mod(u1 - t1);
     a10[i] = mod(u2 - t2);
     u1 = a11[k];
     t1 = omega_array3[8*r+5] * a12[k];
     u2 = a11[i];
     t2 = omega_array3[8*r+5] * a12[i];
     a11[k] = mod(u1 + t1);
     a12[k] = mod(u2 + t2);
     a11[i] = mod(u1 - t1);
     a12[i] = mod(u2 - t2);
     u1 = a13[k];
     t1 = omega_array3[8*r+6] * a14[k];
     u2 = a13[i];
     t2 = omega_array3[8*r+6] * a14[i];
     a13[k] = mod(u1 + t1);
     a14[k] = mod(u2 + t2);
     a13[i] = mod(u1 - t1);
     a14[i] = mod(u2 - t2);
     u1 = a15[k];
     t1 = omega_array3[8*r+7] * a16[k];
     u2 = a15[i];
     t2 = omega_array3[8*r+7] * a16[i];
     a15[k] = mod(u1 + t1);
     a16[k] = mod(u2 + t2);
     a15[i] = mod(u1 - t1);
     a16[i] = mod(u2 - t2);
  }
  for (j = 0; j < 128; j+=8) {//Stage 5 (m=256)
	#pragma HLS PIPELINE II=1
	t1 = omega_array4[j] * a2[j/8];
    u1 = a1[j/8];
    out[2 * j] = mod(u1 + t1);
    out[2 * j + 1] = mod(u1 - t1);

    t1 = omega_array4[j+1] * a4[j/8];
    u1 = a3[j/8];
    out[2 * (j+1)] = mod(u1 + t1);
    out[2 * (j+1) + 1] = mod(u1 - t1);

    t1 = omega_array4[j+2] * a6[j/8];
    u1 = a5[j/8];
    out[2 * (j)+4] = mod(u1 + t1);
    out[2 * (j) + 5] = mod(u1 - t1);

    t1 = omega_array4[j+3] * a8[j/8];
    u1 = a7[j/8];
    out[2 * (j)+6] = mod(u1 + t1);
    out[2 * (j) + 7] = mod(u1 - t1);
    ///

    t1 = omega_array4[j+4] * a10[j/8];
    u1 = a9[j/8];
    out[2 * j+8] = mod(u1 + t1);
    out[2 * j + 9] = mod(u1 - t1);

    t1 = omega_array4[j+5] * a12[j/8];
    u1 = a11[j/8];
    out[2 * (j+5)] = mod(u1 + t1);
    out[2 * (j+5) + 1] = mod(u1 - t1);

    t1 = omega_array4[j+6] * a14[j/8];
    u1 = a13[j/8];
    out[2 * (j)+12] = mod(u1 + t1);
    out[2 * (j) + 13] = mod(u1 - t1);

    t1 = omega_array4[j+7] * a16[j/8];
    u1 = a15[j/8];
    out[2 * (j)+14] = mod(u1 + t1);
    out[2 * (j) +15] = mod(u1 - t1);

  }
}
void fwd_ntt_16_array_512points(uint16_t out[512]) {

#pragma HLS INTERFACE s_axilite port=out bundle=S_AXI_BUNDLE
#pragma HLS INTERFACE s_axilite port=return bundle=S_AXI_BUNDLE

  int i, j, k, m,r,s,t,ii;
  uint32_t u1, t1, u2, t2,u11, t11, u22, t22;

  uint16_t a1[32],a2[32],a3[32],a4[32],a5[32],a6[32],a7[32],a8[32],a9[32],a10[32],a11[32],a12[32],a13[32],a14[32],a15[32],a16[32];
  uint16_t omega_array3[]={5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,7311,3006,5023,2625,8961,563,5728,4821,7311,3006,5023,2625,8961,563,5728,4821,7311,3006,5023,2625,8961,563,5728,4821,7311,3006,5023,2625,8961,563,5728,4821,7311,3006,5023,2625,8961,563,5728,4821,7311,3006,5023,2625,8961,563,5728,4821,7311,3006,5023,2625,8961,563,5728,4821,7311,3006,5023,2625,8961,563,5728,4821,10938,9545,6461,11340,5777,9314,4591,2639,10938,9545,6461,11340,5777,9314,4591,2639,10938,9545,6461,11340,5777,9314,4591,2639,10938,9545,6461,11340,5777,9314,4591,2639,10938,9545,6461,11340,5777,9314,4591,2639,10938,9545,6461,11340,5777,9314,4591,2639,10938,9545,6461,11340,5777,9314,4591,2639,10938,9545,6461,11340,5777,9314,4591,2639,12149,8736,2963,9275,11112,9542,9198,1170,12149,8736,2963,9275,11112,9542,9198,1170,12149,8736,2963,9275,11112,9542,9198,1170,12149,8736,2963,9275,11112,9542,9198,1170,726,11227,2366,7203,2768,9154,11289,955,726,11227,2366,7203,2768,9154,11289,955,726,11227,2366,7203,2768,9154,11289,955,726,11227,2366,7203,2768,9154,11289,955,1853,4805,7393,3201,4255,4846,12208,9970,1853,4805,7393,3201,4255,4846,12208,9970,1853,4805,7393,3201,4255,4846,12208,9970,1853,4805,7393,3201,4255,4846,12208,9970,4611,2294,9238,10963,1635,8577,7969,11499,4611,2294,9238,10963,1635,8577,7969,11499,4611,2294,9238,10963,1635,8577,7969,11499,4611,2294,9238,10963,1635,8577,7969,11499,8340,12144,8011,9048,11336,10530,480,6534,8340,12144,8011,9048,11336,10530,480,6534,6915,2731,10908,9005,5067,3382,5791,334,6915,2731,10908,9005,5067,3382,5791,334,2396,8652,5331,3289,6522,8595,1022,4388,2396,8652,5331,3289,6522,8595,1022,4388,130,6378,4177,5092,12171,4231,9821,1428,130,6378,4177,5092,12171,4231,9821,1428,8993,6747,1673,11560,3748,3707,9447,4632,8993,6747,1673,11560,3748,3707,9447,4632,2837,8357,9764,9408,10092,355,11745,2426,2837,8357,9764,9408,10092,355,11745,2426,4452,3459,7300,10276,11462,5179,12280,1260,4452,3459,7300,10276,11462,5179,12280,1260,7935,7399,8705,10200,9813,2548,11950,10593,7935,7399,8705,10200,9813,2548,11950,10593,3400,5277,3271,10849,9042,4976,12176,3833,3531,4096,9509,4143,8241,9852,1426,9377,9273,2143,4414,7205,8779,11287,12129,5101,10111,10911,9984,8585,3186,2422,8653,5012,5191,11082,10600,9223,2969,11414,2166,11899,3985,5444,7394,12047,9405,9302,10512,354,3000,11885,10115,7404,9424,8005,7852,9888,6730,4337,4053,7270,10163,2187,2704,1045,2399,1168,8232,8526,2686,10682,4919,3778,11813,11796,5195,7575,10040,8643,7635,6591,243,11224,2847,1632,6957,5011,9140,11222,10745,1912,7247,2678,5407,6039,4938,2481,9153,9041,8925,27,3978,8509,8374,773,7384,2381,10805,10752,11136,6267,1663,7428,671,4645,4372,1017,2370,5088,3,442,11869,11854,9644,11744,1630,2566,5291,9430};
  uint16_t omega_array4[]={10302,3150,6281,9407,7822,1404,5468,10232,10930,64,8687,5333,5925,3329,431,3009,6152,922,1105,8855,11239,6099,5057,1489,11821,6370,4782,453,4075,5297,6415,10314,7083,8049,11286,6142,3789,3728,5241,350,10256,6507,3600,156,1973,10695,12138,2738,6427,1958,8851,9928,9606,8527,2049,11026,6950,10542,8076,4774,10120,11089,12237,7535,8724,8243,7280,1954,7540,1146,787,9087,1254,11606,421,5876,8775,9597,2505,723,400,8210,5681,9381,5445,5766,3445,1583,11907,3834,9260,11871,4324,3956,6234,9364,9090,11454,12048,3963,5456,6299,9162,10474,10367,2948,7665,8320,11011,5106,8332,2655,6874,10211,975,9259,8471,8273,10968,6374,6093,9235,605,4737,7210,9734,1323,426,10587,1319,11404,1805,4789,11964,1010,5369,5435,8633,6068,10258,1018,7991,10710,1693,4948,11848,12147,8760,7753,295,7591,2500,8301,7856,6403,6381,5315,6170,677,3757,5529,8719,3532,2447,147,8240,9369,1512,3998,1566,3263,9522,5574,1962,10162,6421,6136,7967,2844,10446,1190,2919,7377,12240,5446,9166,11785,6860,11767,7105,9115,10431,11635,709,1956,2051,5537,11341,8807,7796,11316,9830,8209,2281,1041,168,5906,174,1728,1058,8812,218,3860,11637,7509,6347,316,5257,5594,8517,4916,1360,3336,11942,12233,6224,12231,11713,7840,1159,8120,6906,8410,9786,6077,3991,2344,6328,9450,6554,3643,11177,4212,4115,6118,8212,192,1483,3710,5486,9987,1293,9027,6167,2766,3315};
  for(ii=0;ii<M;ii=ii+16){
	#pragma HLS PIPELINE II=1
	a1[ii/16]=out[ii];
	a2[ii/16]=out[ii+1];
	a3[ii/16]=out[ii+2];
	a4[ii/16]=out[ii+3];
	a5[ii/16]=out[ii+4];
	a6[ii/16]=out[ii+5];
	a7[ii/16]=out[ii+6];
	a8[ii/16]=out[ii+7];
	a9[ii/16]=out[ii+8];
	a10[ii/16]=out[ii+9];
	a11[ii/16]=out[ii+10];
	a12[ii/16]=out[ii+11];
	a13[ii/16]=out[ii+12];
	a14[ii/16]=out[ii+13];
	a15[ii/16]=out[ii+14];
	a16[ii/16]=out[ii+15];
  }

  for (m = 0; m < 32  ; m++){
	#pragma HLS PIPELINE II=1
    u1 = a1[m];
    t1 = (1479 * a2[m]);
    u2 = a3[m];
    t2 = (1479 * a4[m]);
    u11 = a5[m];
    t11 = (1479 * a6[m]);
    u22 = a7[m];
    t22 = (1479 * a8[m]);
    a1[m] = mod(u1 + t1);
    a2[m] = mod(u2 + t2);
    a3[m] = mod(u1 - t1);
    a4[m] = mod(u2 - t2);
    a5[m] = mod(u11 + t11);
    a6[m] = mod(u22 + t22);
    a7[m] = mod(u11 - t11);
    a8[m] = mod(u22 - t22);
    u1 = a9[m];
    t1 = (1479 * a10[m]);
    u2 = a11[m];
    t2 = (1479 * a12[m]);
    u11 = a13[m];
    t11 = (1479 * a14[m]);
    u22 = a15[m];
    t22 = (1479 * a16[m]);
    a9[m] = mod(u1 + t1);
    a10[m] = mod(u2 + t2);
    a11[m] = mod(u1 - t1);
    a12[m] = mod(u2 - t2);
    a13[m] = mod(u11 + t11);
    a14[m] = mod(u22 + t22);
    a15[m] = mod(u11 - t11);
    a16[m] = mod(u22 - t22);
  }
  for (k = 0; k < 32  ; k++){
	#pragma HLS PIPELINE II=1
    u1 = a1[k];
    t1 = (8246 * a2[k]);
    u2 = a5[k];
    t2 = (8246 * a6[k]);
    a1[k] = mod(u1 + t1);
    a2[k] = mod(u2 + t2);
    a5[k] = mod(u1 - t1);
    a6[k] = mod(u2 - t2);
    u1 = a9[k];
    t1 = (8246 * a10[k]);
    u2 = a13[k];
    t2 = (8246 * a14[k]);
    a9[k] = mod(u1 + t1);
    a10[k] = mod(u2 + t2);
    a13[k] = mod(u1 - t1);
    a14[k] = mod(u2 - t2);
    u11 = a3[k];
    t11 = (5146 * a4[k]);
    u22 = a7[k];
    t22 = (5146 * a8[k]);
    a3[k] = mod(u11 + t11);
    a4[k] = mod(u22 + t22);
    a7[k] = mod(u11 - t11);
    a8[k] = mod(u22 - t22);
    u11 = a11[k];
    t11 = (5146 * a12[k]);
    u22 = a15[k];
    t22 = (5146 * a16[k]);
    a11[k] = mod(u11 + t11);
    a12[k] = mod(u22 + t22);
    a15[k] = mod(u11 - t11);
    a16[k] = mod(u22 - t22);
  }
  for (k = 0; k < 32  ; k++){
 	 #pragma HLS PIPELINE II=1
     u1 = a1[k];
     t1 = (4134 * a2[k]);
     u2 = a9[k];
     t2 = (4134 * a10[k]);
     a1[k] = mod(u1 + t1);
     a2[k] = mod(u2 + t2);
     a9[k] = mod(u1 - t1);
     a10[k] = mod(u2 - t2);
     u1 = a3[k];
     t1 = (11567 * a4[k]);
     u2 = a11[k];
     t2 = (11567 * a12[k]);
     a3[k] = mod(u1 + t1);
     a4[k] = mod(u2 + t2);
     a11[k] = mod(u1 - t1);
     a12[k] = mod(u2 - t2);
     u11 = a5[k];
     t11 = (6553 * a6[k]);
     u22 = a13[k];
     t22 = (6553 * a14[k]);
     a5[k] = mod(u11 + t11);
     a6[k] = mod(u22 + t22);
     a13[k] = mod(u11 - t11);
     a14[k] = mod(u22 - t22);
     u11 = a7[k];
     t11 = (1305 * a8[k]);
     u22 = a15[k];
     t22 = (1305 * a16[k]);
     a7[k] = mod(u11 + t11);
     a8[k] = mod(u22 + t22);
     a15[k] = mod(u11 - t11);
     a16[k] = mod(u22 - t22);
   }
  for(r=0;r<80;r++){
 	 #pragma HLS PIPELINE II=1
 	  s=(r) >> (4); // stage
 	  m = 1 << (s);
 	  t=(r - ( s << (4))) ;
 	  j = 2* (t>>(4-(r/16)));
 	  k = 2*m*(r%(16/m))+(j/2);
 	  i=k+m;
 	  u1 = a1[k];
 	  t1 = omega_array3[8*r] * a2[k];
 	  u2 = a1[i];
 	  t2 = omega_array3[8*r] * a2[i];
      a1[k] = mod(u1 + t1);
      a2[k] = mod(u2 + t2);
      a1[i] = mod(u1 - t1);
      a2[i] = mod(u2 - t2);
      u1 = a3[k];
      t1 = omega_array3[8*r+1] * a4[k];
      u2 = a3[i];
      t2 = omega_array3[8*r+1] * a4[i];
      a3[k] = mod(u1 + t1);
      a4[k] = mod(u2 + t2);
      a3[i] = mod(u1 - t1);
      a4[i] = mod(u2 - t2);
      u1 = a5[k];
      t1 = omega_array3[8*r+2] * a6[k];
      u2 = a5[i];
      t2 = omega_array3[8*r+2] * a6[i];
      a5[k] = mod(u1 + t1);
      a6[k] = mod(u2 + t2);
      a5[i] = mod(u1 - t1);
      a6[i] = mod(u2 - t2);
      u1 = a7[k];
      t1 = omega_array3[8*r+3] * a8[k];
      u2 = a7[i];
      t2 = omega_array3[8*r+3] * a8[i];
      a7[k] = mod(u1 + t1);
      a8[k] = mod(u2 + t2);
      a7[i] = mod(u1 - t1);
      a8[i] = mod(u2 - t2);
      u1 = a9[k];
      t1 = omega_array3[8*r+4] * a10[k];
      u2 = a9[i];
      t2 = omega_array3[8*r+4] * a10[i];
      a9[k] = mod(u1 + t1);
      a10[k] = mod(u2 + t2);
      a9[i] = mod(u1 - t1);
      a10[i] = mod(u2 - t2);
      u1 = a11[k];
      t1 = omega_array3[8*r+5] * a12[k];
      u2 = a11[i];
      t2 = omega_array3[8*r+5] * a12[i];
      a11[k] = mod(u1 + t1);
      a12[k] = mod(u2 + t2);
      a11[i] = mod(u1 - t1);
      a12[i] = mod(u2 - t2);
      u1 = a13[k];
      t1 = omega_array3[8*r+6] * a14[k];
      u2 = a13[i];
      t2 = omega_array3[8*r+6] * a14[i];
      a13[k] = mod(u1 + t1);
      a14[k] = mod(u2 + t2);
      a13[i] = mod(u1 - t1);
      a14[i] = mod(u2 - t2);
      u1 = a15[k];
      t1 = omega_array3[8*r+7] * a16[k];
      u2 = a15[i];
      t2 = omega_array3[8*r+7] * a16[i];
      a15[k] = mod(u1 + t1);
      a16[k] = mod(u2 + t2);
      a15[i] = mod(u1 - t1);
      a16[i] = mod(u2 - t2);
  }
  for (j = 0; j < 256; j+=8) {
	#pragma HLS PIPELINE II=1
	t1 = omega_array4[j] * a2[j/8];
    u1 = a1[j/8];
    out[2 * j] = mod(u1 + t1);
    out[2 * j + 1] = mod(u1 - t1);

    t1 = omega_array4[j+1] * a4[j/8];
    u1 = a3[j/8];
    out[2 * (j+1)] = mod(u1 + t1);
    out[2 * (j+1) + 1] = mod(u1 - t1);

    t1 = omega_array4[j+2] * a6[j/8];
    u1 = a5[j/8];
    out[2 * (j)+4] = mod(u1 + t1);
    out[2 * (j) + 5] = mod(u1 - t1);

    t1 = omega_array4[j+3] * a8[j/8];
    u1 = a7[j/8];
    out[2 * (j)+6] = mod(u1 + t1);
    out[2 * (j) + 7] = mod(u1 - t1);

    t1 = omega_array4[j+4] * a10[j/8];
    u1 = a9[j/8];
    out[2 * j+8] = mod(u1 + t1);
    out[2 * j + 9] = mod(u1 - t1);

    t1 = omega_array4[j+5] * a12[j/8];
    u1 = a11[j/8];
    out[2 * (j+5)] = mod(u1 + t1);
    out[2 * (j+5) + 1] = mod(u1 - t1);

    t1 = omega_array4[j+6] * a14[j/8];
    u1 = a13[j/8];
    out[2 * (j)+12] = mod(u1 + t1);
    out[2 * (j) + 13] = mod(u1 - t1);

    t1 = omega_array4[j+7] * a16[j/8];
    u1 = a15[j/8];
    out[2 * (j)+14] = mod(u1 + t1);
    out[2 * (j) +15] = mod(u1 - t1);

  }
}
void fwd_ntt_16_array_1024points(uint16_t out[1024]) {

	int i, j, k, m,r,s,t,ii;
	uint32_t u1, t1, u2, t2,u11, t11, u22, t22;
	uint16_t a1[64],a2[64],a3[64],a4[64],a5[64],a6[64],a7[64],a8[64],a9[64],a10[64],a11[64],a12[64],a13[64],a14[64],a15[64],a16[64];
	uint16_t omega_array3[]={5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,5860,3621,1212,8785,3195,9744,10643,3542,7311,3006,5023,2625,8961,563,5728,4821,7311,3006,5023,2625,8961,563,5728,4821,7311,3006,5023,2625,8961,563,5728,4821,7311,3006,5023,2625,8961,563,5728,4821,7311,3006,5023,2625,8961,563,5728,4821,7311,3006,5023,2625,8961,563,5728,4821,7311,3006,5023,2625,8961,563,5728,4821,7311,3006,5023,2625,8961,563,5728,4821,7311,3006,5023,2625,8961,563,5728,4821,7311,3006,5023,2625,8961,563,5728,4821,7311,3006,5023,2625,8961,563,5728,4821,7311,3006,5023,2625,8961,563,5728,4821,7311,3006,5023,2625,8961,563,5728,4821,7311,3006,5023,2625,8961,563,5728,4821,7311,3006,5023,2625,8961,563,5728,4821,7311,3006,5023,2625,8961,563,5728,4821,10938,9545,6461,11340,5777,9314,4591,2639,10938,9545,6461,11340,5777,9314,4591,2639,10938,9545,6461,11340,5777,9314,4591,2639,10938,9545,6461,11340,5777,9314,4591,2639,10938,9545,6461,11340,5777,9314,4591,2639,10938,9545,6461,11340,5777,9314,4591,2639,10938,9545,6461,11340,5777,9314,4591,2639,10938,9545,6461,11340,5777,9314,4591,2639,10938,9545,6461,11340,5777,9314,4591,2639,10938,9545,6461,11340,5777,9314,4591,2639,10938,9545,6461,11340,5777,9314,4591,2639,10938,9545,6461,11340,5777,9314,4591,2639,10938,9545,6461,11340,5777,9314,4591,2639,10938,9545,6461,11340,5777,9314,4591,2639,10938,9545,6461,11340,5777,9314,4591,2639,10938,9545,6461,11340,5777,9314,4591,2639,12149,8736,2963,9275,11112,9542,9198,1170,12149,8736,2963,9275,11112,9542,9198,1170,12149,8736,2963,9275,11112,9542,9198,1170,12149,8736,2963,9275,11112,9542,9198,1170,12149,8736,2963,9275,11112,9542,9198,1170,12149,8736,2963,9275,11112,9542,9198,1170,12149,8736,2963,9275,11112,9542,9198,1170,12149,8736,2963,9275,11112,9542,9198,1170,726,11227,2366,7203,2768,9154,11289,955,726,11227,2366,7203,2768,9154,11289,955,726,11227,2366,7203,2768,9154,11289,955,726,11227,2366,7203,2768,9154,11289,955,726,11227,2366,7203,2768,9154,11289,955,726,11227,2366,7203,2768,9154,11289,955,726,11227,2366,7203,2768,9154,11289,955,726,11227,2366,7203,2768,9154,11289,955,1853,4805,7393,3201,4255,4846,12208,9970,1853,4805,7393,3201,4255,4846,12208,9970,1853,4805,7393,3201,4255,4846,12208,9970,1853,4805,7393,3201,4255,4846,12208,9970,1853,4805,7393,3201,4255,4846,12208,9970,1853,4805,7393,3201,4255,4846,12208,9970,1853,4805,7393,3201,4255,4846,12208,9970,1853,4805,7393,3201,4255,4846,12208,9970,4611,2294,9238,10963,1635,8577,7969,11499,4611,2294,9238,10963,1635,8577,7969,11499,4611,2294,9238,10963,1635,8577,7969,11499,4611,2294,9238,10963,1635,8577,7969,11499,4611,2294,9238,10963,1635,8577,7969,11499,4611,2294,9238,10963,1635,8577,7969,11499,4611,2294,9238,10963,1635,8577,7969,11499,4611,2294,9238,10963,1635,8577,7969,11499,8340,12144,8011,9048,11336,10530,480,6534,8340,12144,8011,9048,11336,10530,480,6534,8340,12144,8011,9048,11336,10530,480,6534,8340,12144,8011,9048,11336,10530,480,6534,6915,2731,10908,9005,5067,3382,5791,334,6915,2731,10908,9005,5067,3382,5791,334,6915,2731,10908,9005,5067,3382,5791,334,6915,2731,10908,9005,5067,3382,5791,334,2396,8652,5331,3289,6522,8595,1022,4388,2396,8652,5331,3289,6522,8595,1022,4388,2396,8652,5331,3289,6522,8595,1022,4388,2396,8652,5331,3289,6522,8595,1022,4388,130,6378,4177,5092,12171,4231,9821,1428,130,6378,4177,5092,12171,4231,9821,1428,130,6378,4177,5092,12171,4231,9821,1428,130,6378,4177,5092,12171,4231,9821,1428,8993,6747,1673,11560,3748,3707,9447,4632,8993,6747,1673,11560,3748,3707,9447,4632,8993,6747,1673,11560,3748,3707,9447,4632,8993,6747,1673,11560,3748,3707,9447,4632,2837,8357,9764,9408,10092,355,11745,2426,2837,8357,9764,9408,10092,355,11745,2426,2837,8357,9764,9408,10092,355,11745,2426,2837,8357,9764,9408,10092,355,11745,2426,4452,3459,7300,10276,11462,5179,12280,1260,4452,3459,7300,10276,11462,5179,12280,1260,4452,3459,7300,10276,11462,5179,12280,1260,4452,3459,7300,10276,11462,5179,12280,1260,7935,7399,8705,10200,9813,2548,11950,10593,7935,7399,8705,10200,9813,2548,11950,10593,7935,7399,8705,10200,9813,2548,11950,10593,7935,7399,8705,10200,9813,2548,11950,10593,3400,5277,3271,10849,9042,4976,12176,3833,3400,5277,3271,10849,9042,4976,12176,3833,3531,4096,9509,4143,8241,9852,1426,9377,3531,4096,9509,4143,8241,9852,1426,9377,9273,2143,4414,7205,8779,11287,12129,5101,9273,2143,4414,7205,8779,11287,12129,5101,10111,10911,9984,8585,3186,2422,8653,5012,10111,10911,9984,8585,3186,2422,8653,5012,5191,11082,10600,9223,2969,11414,2166,11899,5191,11082,10600,9223,2969,11414,2166,11899,3985,5444,7394,12047,9405,9302,10512,354,3985,5444,7394,12047,9405,9302,10512,354,3000,11885,10115,7404,9424,8005,7852,9888,3000,11885,10115,7404,9424,8005,7852,9888,6730,4337,4053,7270,10163,2187,2704,1045,6730,4337,4053,7270,10163,2187,2704,1045,2399,1168,8232,8526,2686,10682,4919,3778,2399,1168,8232,8526,2686,10682,4919,3778,11813,11796,5195,7575,10040,8643,7635,6591,11813,11796,5195,7575,10040,8643,7635,6591,243,11224,2847,1632,6957,5011,9140,11222,243,11224,2847,1632,6957,5011,9140,11222,10745,1912,7247,2678,5407,6039,4938,2481,10745,1912,7247,2678,5407,6039,4938,2481,9153,9041,8925,27,3978,8509,8374,773,9153,9041,8925,27,3978,8509,8374,773,7384,2381,10805,10752,11136,6267,1663,7428,7384,2381,10805,10752,11136,6267,1663,7428,671,4645,4372,1017,2370,5088,3,442,671,4645,4372,1017,2370,5088,3,442,11869,11854,9644,11744,1630,2566,5291,9430,11869,11854,9644,11744,1630,2566,5291,9430,10302,3150,6281,9407,7822,1404,5468,10232,10930,64,8687,5333,5925,3329,431,3009,6152,922,1105,8855,11239,6099,5057,1489,11821,6370,4782,453,4075,5297,6415,10314,7083,8049,11286,6142,3789,3728,5241,350,10256,6507,3600,156,1973,10695,12138,2738,6427,1958,8851,9928,9606,8527,2049,11026,6950,10542,8076,4774,10120,11089,12237,7535,8724,8243,7280,1954,7540,1146,787,9087,1254,11606,421,5876,8775,9597,2505,723,400,8210,5681,9381,5445,5766,3445,1583,11907,3834,9260,11871,4324,3956,6234,9364,9090,11454,12048,3963,5456,6299,9162,10474,10367,2948,7665,8320,11011,5106,8332,2655,6874,10211,975,9259,8471,8273,10968,6374,6093,9235,605,4737,7210,9734,1323,426,10587,1319,11404,1805,4789,11964,1010,5369,5435,8633,6068,10258,1018,7991,10710,1693,4948,11848,12147,8760,7753,295,7591,2500,8301,7856,6403,6381,5315,6170,677,3757,5529,8719,3532,2447,147,8240,9369,1512,3998,1566,3263,9522,5574,1962,10162,6421,6136,7967,2844,10446,1190,2919,7377,12240,5446,9166,11785,6860,11767,7105,9115,10431,11635,709,1956,2051,5537,11341,8807,7796,11316,9830,8209,2281,1041,168,5906,174,1728,1058,8812,218,3860,11637,7509,6347,316,5257,5594,8517,4916,1360,3336,11942,12233,6224,12231,11713,7840,1159,8120,6906,8410,9786,6077,3991,2344,6328,9450,6554,3643,11177,4212,4115,6118,8212,192,1483,3710,5486,9987,1293,9027,6167,2766,3315};
	uint16_t omega_array4[]={10344,5969,10771,5461,180,11010,9839,1706,1942,12281,3607,9667,11667,7014,11197,6940,10767,1120,11158,10699,1057,1160,5412,11520,4167,2957,10872,1398,11777,9646,4238,9348,6492,3846,1756,904,10235,1350,8841,6203,506,2276,12229,8619,4913,7624,3449,4099,2894,874,8400,9951,364,1783,8700,3723,377,530,3744,7806,10485,8449,10900,7207,8665,11823,4267,881,6780,9173,10125,11007,3511,3795,4781,11839,9342,6125,8024,7434,20,9416,6555,1555,7043,2730,7228,3805,9489,8972,3975,3502,9389,11048,8067,8016,11041,9687,8794,1280,463,1694,1208,8348,2674,7899,10029,5135,8914,8620,2926,11024,6599,150,9175,6151,5518,9811,8186,5054,10104,3578,5845,11379,1687,2828,9126,5202,10964,2929,5063,4510,9600,9617,416,9060,1165,7766,3942,7628,7790,5410,3205,9656,8946,6481,1125,1223,3121,4518,5993,12239,1038,2046,2257,826,5464,6508,8921,7000,2148,8496,3534,7250,9247,10555,4538,3120,6505,2593,9089,4987,8054,9269,3708,5604,10975,5650,5596,2293,3028,4974,9307,1936,11914,7785,3056,10783,6195,4113,11943,11607,3344,3821,2275,1927,5219,1763,11573,9457,11111,5776,1014,578,6680,11249,1928,3232,5163,2434,5508,5103,11053,10421,438,2213,2231,3332,3087,10631,994,3451,125,9694,7174,502,10224,10918,8308,8420,7078,6919,3338,3454,6453,7605,4335,944,4489,2171,11951,8000,5966,4443,7550,3019,10568,3285,10453,10588,412,4719,12143,7455,7449,7082,11260,4649,3765,2946,8151,865,1705,3929,8881,457,1327,5386,1737,1790,7080,2945,10138,9754,10844,7878,2600,7469,4209,5526,6204,10808,5676,3090,4670,11194,612,567,3959,10716,4145,9804,9806,5832,343,6643,11034,11307,9572,3808,3528,6883,1136,3944,3654,2301,11710,7596,9929,7211,717,845,4578,9663,7326,5703,10886,10447,10221,4590,10397,11259,6636,365,12085,12100,6873,8717,6811,9021,4924,10345,3982,1882,8611,8520,5002,2827,11113,1802,7814,6878,11071,11522,193,9757,4883,5789,12050,7911,10763,9068,9847,10388,4564,614,8882,10759,4727,8536,10077,8071,68,63,9998,5287,1826,9282,2455,648,2769,3469,1226,9449,2429,3154,392,7592,5588,5900,406,4352,4032,844,6565,6263,4176,9652,4605,5170,814,4730,2575,7988,5232,510,6617,1251,8930,1406,8170,12268,4860,2334,7584,9195,3278,12073,11366,2940,7784,5043,7383,3045,8062,5662,6330,6226,3961,6742,10945,3815,1908,6105,10897,879,10754,2373,3825,6616,3238,5530,10545,12119,5987,11872,5216,7724,1373,7,10669,11511,9761,9224,7100,72,4404,11309,5598,10608,9828,11274,1409,2209,10179,2021,2776,1849,448,6921,11653,10254,464,11996,4608,11498,11014,1891,3017,2253,8774,4153,6197,139,6454,5618,7735,4094,540,8452,4939,5118,5826,12265,10821,4423,10423,8753,9013,8531,7723,3360,8896,7519,3171,3480,3947,9982,212,8871,8038,4194,10753,4360,425,3466,7187,11538,5268,2712,6127,4050};
	for(ii=0;ii<M;ii=ii+16){
		#pragma HLS PIPELINE II=1
		a1[ii/16]=out[ii];
		a2[ii/16]=out[ii+1];
		a3[ii/16]=out[ii+2];
		a4[ii/16]=out[ii+3];
		a5[ii/16]=out[ii+4];
		a6[ii/16]=out[ii+5];
		a7[ii/16]=out[ii+6];
		a8[ii/16]=out[ii+7];
		a9[ii/16]=out[ii+8];
		a10[ii/16]=out[ii+9];
		a11[ii/16]=out[ii+10];
		a12[ii/16]=out[ii+11];
		a13[ii/16]=out[ii+12];
		a14[ii/16]=out[ii+13];
		a15[ii/16]=out[ii+14];
		a16[ii/16]=out[ii+15];
	}

	for (m = 0; m < 64  ; m++){
		#pragma HLS PIPELINE II=1
        u1 = a1[m];
        t1 = (1479 * a2[m]);

        u2 = a3[m];
        t2 = (1479 * a4[m]);
//
        u11 = a5[m];
        t11 = (1479 * a6[m]);

        u22 = a7[m];
        t22 = (1479 * a8[m]);
        a1[m] = mod(u1 + t1);
        a2[m] = mod(u2 + t2);

        a3[m] = mod(u1 - t1);
        a4[m] = mod(u2 - t2);
        //
        a5[m] = mod(u11 + t11);
        a6[m] = mod(u22 + t22);

        a7[m] = mod(u11 - t11);
        a8[m] = mod(u22 - t22);
        u1 = a9[m];
        t1 = (1479 * a10[m]);

        u2 = a11[m];
        t2 = (1479 * a12[m]);
//
        u11 = a13[m];
        t11 = (1479 * a14[m]);

        u22 = a15[m];
        t22 = (1479 * a16[m]);
        a9[m] = mod(u1 + t1);
        a10[m] = mod(u2 + t2);

        a11[m] = mod(u1 - t1);
        a12[m] = mod(u2 - t2);
        //
        a13[m] = mod(u11 + t11);
        a14[m] = mod(u22 + t22);

        a15[m] = mod(u11 - t11);
        a16[m] = mod(u22 - t22);
  }
	for (k = 0; k < 64  ; k++){
		#pragma HLS PIPELINE II=1
		u1 = a1[k];
		t1 = (8246 * a2[k]);
		u2 = a5[k];
		t2 = (8246 * a6[k]);
		a1[k] = mod(u1 + t1);
		a2[k] = mod(u2 + t2);
		a5[k] = mod(u1 - t1);
		a6[k] = mod(u2 - t2);
		u1 = a9[k];
		t1 = (8246 * a10[k]);
		u2 = a13[k];
		t2 = (8246 * a14[k]);
		a9[k] = mod(u1 + t1);
		a10[k] = mod(u2 + t2);
		a13[k] = mod(u1 - t1);
		a14[k] = mod(u2 - t2);
		u11 = a3[k];
		t11 = (5146 * a4[k]);
		u22 = a7[k];
		t22 = (5146 * a8[k]);
		a3[k] = mod(u11 + t11);
		a4[k] = mod(u22 + t22);
		a7[k] = mod(u11 - t11);
		a8[k] = mod(u22 - t22);
		u11 = a11[k];
		t11 = (5146 * a12[k]);
		u22 = a15[k];
		t22 = (5146 * a16[k]);
		a11[k] = mod(u11 + t11);
		a12[k] = mod(u22 + t22);
		a15[k] = mod(u11 - t11);
		a16[k] = mod(u22 - t22);
	}
	for (k = 0; k < 64  ; k++){
 	   #pragma HLS PIPELINE II=1
       u1 = a1[k];
       t1 = (4134 * a2[k]);
       u2 = a9[k];
       t2 = (4134 * a10[k]);
       a1[k] = mod(u1 + t1);
       a2[k] = mod(u2 + t2);
       a9[k] = mod(u1 - t1);
       a10[k] = mod(u2 - t2);
       u1 = a3[k];
       t1 = (11567 * a4[k]);
       u2 = a11[k];
       t2 = (11567 * a12[k]);
       a3[k] = mod(u1 + t1);
       a4[k] = mod(u2 + t2);
       a11[k] = mod(u1 - t1);
       a12[k] = mod(u2 - t2);
       u11 = a5[k];
       t11 = (6553 * a6[k]);
       u22 = a13[k];
       t22 = (6553 * a14[k]);
       a5[k] = mod(u11 + t11);
       a6[k] = mod(u22 + t22);
       a13[k] = mod(u11 - t11);
       a14[k] = mod(u22 - t22);
       u11 = a7[k];
       t11 = (1305 * a8[k]);
       u22 = a15[k];
       t22 = (1305 * a16[k]);
       a7[k] = mod(u11 + t11);
       a8[k] = mod(u22 + t22);
       a15[k] = mod(u11 - t11);
       a16[k] = mod(u22 - t22);
   }

	for(r=0;r<192;r++){
 		#pragma HLS PIPELINE II=1
		s=(r) >> (5); // stage
		m = 1 << (s);
		t=(r - ( s << (5))) ;
		j = 2* (t>>(5-(r/32)));
		k = 2*m*(r%(32/m))+(j/2);
		i=k+m;

        u1 = a1[k];
        t1 = omega_array3[8*r] * a2[k];
        u2 = a1[i];
        t2 = omega_array3[8*r] * a2[i];
        a1[k] = mod(u1 + t1);
        a2[k] = mod(u2 + t2);
        a1[i] = mod(u1 - t1);
        a2[i] = mod(u2 - t2);
        u1 = a3[k];
        t1 = omega_array3[8*r+1] * a4[k];
        u2 = a3[i];
        t2 = omega_array3[8*r+1] * a4[i];
        a3[k] = mod(u1 + t1);
        a4[k] = mod(u2 + t2);
        a3[i] = mod(u1 - t1);
        a4[i] = mod(u2 - t2);
        u1 = a5[k];
        t1 = omega_array3[8*r+2] * a6[k];
        u2 = a5[i];
        t2 = omega_array3[8*r+2] * a6[i];
        a5[k] = mod(u1 + t1);
        a6[k] = mod(u2 + t2);
        a5[i] = mod(u1 - t1);
        a6[i] = mod(u2 - t2);
        u1 = a7[k];
        t1 = omega_array3[8*r+3] * a8[k];
        u2 = a7[i];
        t2 = omega_array3[8*r+3] * a8[i];
        a7[k] = mod(u1 + t1);
        a8[k] = mod(u2 + t2);
        a7[i] = mod(u1 - t1);
        a8[i] = mod(u2 - t2);
        u1 = a9[k];
        t1 = omega_array3[8*r+4] * a10[k];
        u2 = a9[i];
        t2 = omega_array3[8*r+4] * a10[i];
        a9[k] = mod(u1 + t1);
        a10[k] = mod(u2 + t2);
        a9[i] = mod(u1 - t1);
        a10[i] = mod(u2 - t2);
        u1 = a11[k];
        t1 = omega_array3[8*r+5] * a12[k];
        u2 = a11[i];
        t2 = omega_array3[8*r+5] * a12[i];
        a11[k] = mod(u1 + t1);
        a12[k] = mod(u2 + t2);
        a11[i] = mod(u1 - t1);
        a12[i] = mod(u2 - t2);
        u1 = a13[k];
        t1 = omega_array3[8*r+6] * a14[k];
        u2 = a13[i];
        t2 = omega_array3[8*r+6] * a14[i];
        a13[k] = mod(u1 + t1);
        a14[k] = mod(u2 + t2);
        a13[i] = mod(u1 - t1);
        a14[i] = mod(u2 - t2);
        u1 = a15[k];
        t1 = omega_array3[8*r+7] * a16[k];
        u2 = a15[i];
        t2 = omega_array3[8*r+7] * a16[i];
        a15[k] = mod(u1 + t1);
        a16[k] = mod(u2 + t2);
        a15[i] = mod(u1 - t1);
        a16[i] = mod(u2 - t2);
	}
	for (j = 0; j < 512; j+=8) {
		#pragma HLS PIPELINE II=1
		t1 = omega_array4[j] * a2[j/8];
		u1 = a1[j/8];
		out[2 * j] = mod(u1 + t1);
		out[2 * j + 1] = mod(u1 - t1);
		t1 = omega_array4[j+1] * a4[j/8];
		u1 = a3[j/8];
		out[2 * (j+1)] = mod(u1 + t1);
		out[2 * (j+1) + 1] = mod(u1 - t1);
		t1 = omega_array4[j+2] * a6[j/8];
		u1 = a5[j/8];
		out[2 * (j)+4] = mod(u1 + t1);
		out[2 * (j) + 5] = mod(u1 - t1);
		t1 = omega_array4[j+3] * a8[j/8];
		u1 = a7[j/8];
		out[2 * (j)+6] = mod(u1 + t1);
		out[2 * (j) + 7] = mod(u1 - t1);
		t1 = omega_array4[j+4] * a10[j/8];
		u1 = a9[j/8];
		out[2 * j+8] = mod(u1 + t1);
		out[2 * j + 9] = mod(u1 - t1);
		t1 = omega_array4[j+5] * a12[j/8];
		u1 = a11[j/8];
		out[2 * (j+5)] = mod(u1 + t1);
		out[2 * (j+5) + 1] = mod(u1 - t1);
		t1 = omega_array4[j+6] * a14[j/8];
		u1 = a13[j/8];
		out[2 * (j)+12] = mod(u1 + t1);
		out[2 * (j) + 13] = mod(u1 - t1);
		t1 = omega_array4[j+7] * a16[j/8];
		u1 = a15[j/8];
		out[2 * (j)+14] = mod(u1 + t1);
		out[2 * (j) +15] = mod(u1 - t1);
	}
}

void coefficient_mul2(uint16_t out[M], uint16_t b[], uint16_t c[]) {
  // a = b * c
  int j;
  for (j = 0; j < M; j++) {
	#pragma HLS PIPELINE II=1
    out[j] = mod((uint32_t)((uint32_t)b[j] * (uint32_t)c[j]));
  }
}
void coefficient_add2(uint16_t out[M], uint16_t b[M], uint16_t c[M])
{
  // a = b + c
  int j;
  for (j = 0; j < M; j++) {
	#pragma HLS PIPELINE II=1
	out[j] = mod((uint32_t)(b[j] + c[j]));
  }
}
void rearrange2(uint16_t a[M]) {

  uint32_t i;
  uint32_t bit1, bit2, bit3, bit4, bit5, bit6, bit7;
  uint32_t swp_index;

  uint16_t u1, u2;

  for (i = 1; i < M / 2; i++) {
	#pragma HLS PIPELINE II=1
    bit1 = i % 2;
    bit2 = (i >> 1) % 2;
    bit3 = (i >> 2) % 2;
    bit4 = (i >> 3) % 2;
    bit5 = (i >> 4) % 2;
    bit6 = (i >> 5) % 2;
    bit7 = (i >> 6) % 2;

#ifdef NTT512
    int bit8 = (i >> 7) % 2;
    swp_index = bit1 * 128 + bit2 * 64 + bit3 * 32 + bit4 * 16 + bit5 * 8 +
                bit6 * 4 + bit7 * 2 + bit8;
#else
    swp_index = bit1 * 64 + bit2 * 32 + bit3 * 16 + bit4 * 8 + bit5 * 4 +
                bit6 * 2 + bit7;
#endif

    if (swp_index > i) {
      u1 = a[2 * i];
      u2 = a[2 * i + 1];

      a[2 * i] = a[2 * swp_index];
      a[2 * i + 1] = a[2 * swp_index + 1];

      a[2 * swp_index] = u1;
      a[2 * swp_index + 1] = u2;
    }
  }
}
void rearrange1024(uint16_t a[M]) {// rearrange2 function for n=1024 points input

  uint32_t i;
  uint32_t bit1, bit2, bit3, bit4, bit5, bit6, bit7;
  uint32_t swp_index;

  uint16_t u1, u2;

  for (i = 1; i < M / 2; i++) {
#pragma HLS PIPELINE II=1
    bit1 = i % 2;
    bit2 = (i >> 1) % 2;
    bit3 = (i >> 2) % 2;
    bit4 = (i >> 3) % 2;
    bit5 = (i >> 4) % 2;
    bit6 = (i >> 5) % 2;
    bit7 = (i >> 6) % 2;

#ifdef NTT512
    int bit8 = (i >> 7) % 2;
    int bit9 = (i >> 8) % 2;
    swp_index = bit1 * 256 + bit2 * 128 + bit3 * 64 + bit4 * 32 + bit5 * 16 +
                bit6 * 8 + bit7 * 4 + bit8*2+bit9;
#else
    swp_index = bit1 * 64 + bit2 * 32 + bit3 * 16 + bit4 * 8 + bit5 * 4 +
                bit6 * 2 + bit7;
#endif

    if (swp_index > i) {
      u1 = a[2 * i];
      u2 = a[2 * i + 1];

      a[2 * i] = a[2 * swp_index];
      a[2 * i + 1] = a[2 * swp_index + 1];

      a[2 * swp_index] = u1;
      a[2 * swp_index + 1] = u2;
    }
  }
}


int shift_lfsr(uint *lfsr,  uint polymonial_mask)
{

	int feedback;
	#pragma HLS PIPELINE II=1
    feedback = *lfsr & 1;
    *lfsr >>= 1;
    if (feedback == 1)
        *lfsr ^= polymonial_mask;
    return *lfsr;
}


int get_random(void)
{

    /*this random number generator shifts the 32-bit LFSR twice before XORing
      it with the 31-bit LFSR. the bottom 16 bits are used for the random number*/
    shift_lfsr(&lfsr32, POLY_MASK_32);
    return(shift_lfsr(&lfsr32, POLY_MASK_32) ^ shift_lfsr(&lfsr31, POLY_MASK_31));
}

uint32_t get_rand(){
	//init_lfsrs();
	uint32_t rnd = get_random();
	rnd |= 0x80000000; // set the least significant bit
	return rnd;
}

uint32_t get_rand_basic(){
	return rand();
}
uint32_t knuth_yao_single_number(uint32_t *rnd, int * sample_in_table)
{
  int distance;
  int row, column;

  uint32_t index, sample, sample_msb;

#ifdef DEBUG_PRINTF
  printf("Start rnd:%x\n", *rnd);
#endif
  index = (*rnd) & 0xff;
  (*rnd) = (*rnd) >> 8;

  sample = lut1[index]; // M elements in lut1
  sample_msb = sample & 16;
  if (sample_msb == 0) // lookup was successful
  {
    if ((*rnd) == NEW_RND_BOTTOM) {
      (*rnd) = get_rand();
    }
    sample = sample & 0xf;
    if ((*rnd) & 1)
      sample = (MODULUS - sample); // 9th bit in rnd is the sign
    (*rnd) = (*rnd) >> 1;
    // We know that in the next call we will need 8 bits!
    if (clz(*rnd) > (NEW_RND_LARGE)) {
      (*rnd) = get_rand();
    }
#ifdef DEBUG_PRINTF
    printf("lut1:%x\n", sample);
#endif
    *sample_in_table=1;
    return sample;
  } else {
    if (clz(*rnd) > (NEW_RND_MID)) {
      (*rnd) = get_rand();
    }
    distance = sample & KN_DISTANCE1_MASK;
    index = ((*rnd) & 0x1f) + 32 * distance;
    (*rnd) = (*rnd) >> 5;
    if ((*rnd) == NEW_RND_BOTTOM) {
      (*rnd) = get_rand();
    }
    sample = lut2[index]; // 224 elements in lut2
    sample_msb = sample & 32;
    if (sample_msb == 0) // lookup was successful
    {
      sample = sample & 31;
      if ((*rnd) & 1)
        sample = (MODULUS - sample); // 9th bit in rnd is the sign
      (*rnd) = (*rnd) >> 1;
      if (clz(*rnd) > (NEW_RND_LARGE)) {
        (*rnd) = get_rand();
      }
#ifdef DEBUG_PRINTF
      printf("lut2:%x\n", sample);
#endif
      *sample_in_table=1;
      return sample;
    } else {
      // Real knuth-yao bitscanning
      distance = sample & KN_DISTANCE2_MASK;
      for (column = 13; (column < PMAT_MAX_COL); column++) {
	  	  #pragma HLS loop_flatten
	  	  #pragma HLS PIPELINE II=1
    	  distance = distance * 2 + ((*rnd) & 1);
    	  (*rnd) = (*rnd) >> 1;
    	  if ((*rnd) == NEW_RND_BOTTOM) {
    		  (*rnd) = get_rand();
    	  }
#ifdef DEBUG_PRINTF
        printf("rnd:%x, dist:%d, col:%d\n", (*rnd), distance, column);
#endif

        // Read probability-column 0 and count the number of non-zeros
        for (row = 54; row >= 0; row--) {
			#pragma HLS PIPELINE II=1
        	distance = distance - pmat[row][column];
        	if (distance < 0) {
#ifdef DEBUG_PRINTF
            printf("rnd:%d", (*rnd));
#endif
            	if ((*rnd) & 1)
            		sample = (MODULUS - row);
            	else
            		sample = row;
            		(*rnd) = (*rnd) >> 1;
            	if (clz(*rnd) > (NEW_RND_LARGE)) {
            		(*rnd) = get_rand();
            	}

            	*sample_in_table=0;
            	return sample;
        	}
        }
        // rnd = rnd >> 1;
      }
    }
  }

  *sample_in_table=0;
  return 0xffffffff;
}

void knuth_yao2(uint16_t a[M]) {
  int i;
  uint32_t rnd;
  int sample_in_table;
  rnd = get_rand();
  for (i = 0; i < M / 2; i++) {
#ifdef DISABLE_KNUTH_YAO
    a[2 * i + 1] = 0;
    a[2 * i] = 0;
#else
    a[2 * i] = knuth_yao_single_number(&rnd,&sample_in_table);
    a[2 * i+1] = knuth_yao_single_number(&rnd,&sample_in_table);
#endif
  }
}

void RLWE_enc2(uint16_t a[M], uint16_t c1[M], uint16_t c2[M], uint16_t m[M], uint16_t p[M])
{
	int i;
	uint16_t e1[M], e2[M], e3[M];																				   ;
	uint16_t encoded_m[M];

	for (i = 0; i < M; i++) {
		#pragma HLS PIPELINE II=1
	    encoded_m[i] = m[i] * QBY2; // encoding of message
	}
	knuth_yao2(e1);
	knuth_yao2(e2);
	knuth_yao2(e3);

	coefficient_add2(e3, e3, encoded_m); // e3 <-- e3 + m*/  //1100

	fwd_ntt2_flatten(e1);
	fwd_ntt2_flatten(e2);
	fwd_ntt2_flatten(e3);
	// m <-- a*e1
	coefficient_mul2(c1, a, e1);  // c1 <-- a*e1  1158
	coefficient_add2(c1, e2, c1); // c1 <-- e2 + a*e1(tmp_m);
	coefficient_mul2(c2, p, e1);  // c2 <-- p*e1
	coefficient_add2(c2, e3, c2); // c2<-- e3 + p*e1*/

	rearrange2(c1);
	rearrange2(c2);
}
void inv_ntt2(uint16_t a[M]) {//Inverse NTT operation with new parameters for omega
  int j, k, m;
  uint32_t u1, t1, u2, t2;
  uint32_t primrt, omega;
  primrt = 0;

  for (m = 2; m <= M / 2; m = 2 * m) {
	#pragma HLS loop_flatten
	#pragma HLS PIPELINE II=1
	#ifdef NTT512
    switch (m) {
    case 2:
      primrt = 12288;
      break;
    case 4:
      primrt = 10810;
      break;
    case 8:
      primrt = 7143;
      break;
    case 16:
      primrt = 10984;
      break;
    case 32:
      primrt = 3542;
      break;
    case 64:
      primrt = 4821;
      break;
    case 128:
      primrt = 1170;
      break;
    case 256:
      primrt = 5755;
      break;
    }
	#else
    switch (m) {
    case 2:
      primrt = 7680;
      break;
    case 4:
      primrt = 3383;
      break;
    case 8:
      primrt = 5756;
      break;
    case 16:
      primrt = 1728;
      break;
    case 32:
      primrt = 7584;
      break;
    case 64:
      primrt = 6569;
      break;
    case 128:
      primrt = 6601;
      break;
    }
	#endif

    omega = 1;
    for (j = 0; j < m / 2; j++) {
    	for (k = 0; k < M / 2; k = k + m) {
			#pragma HLS PIPELINE II=1
    		t1 = omega * a[2 * (k + j) + 1];
    		t1 = mod(t1);
    		u1 = a[2 * (k + j)];
    		t2 = omega * a[2 * (k + j + m / 2) + 1];
    		t2 = mod(t2);
    		u2 = a[2 * (k + j + m / 2)];

    		a[2 * (k + j)] = mod(u1 + t1);
    		a[2 * (k + j + m / 2)] = mod(u1 - t1);

    		a[2 * (k + j) + 1] = mod(u2 + t2);
    		a[2 * (k + j + m / 2) + 1] = mod(u2 - t2);
    	}
    	omega = omega * primrt;
    	omega = mod(omega);
    }
  }

  primrt = INVCONST1;
  omega = 1;
  for (j = 0; j < M;) {
	#pragma HLS PIPELINE II=1
    u1 = a[j];
    j++;
    t1 = omega * a[j];
    t1 = mod(t1);

    a[j - 1] = mod(u1 + t1);
    a[j] = mod(u1 - t1);
    j++;

    omega = omega * primrt;
    omega = mod(omega);
  }
  uint32_t omega2 = INVCONST2;
  primrt = INVCONST3;
  omega = 1;

  for (j = 0; j < M;) {
	#pragma HLS PIPELINE II=1
    a[j] = mod(omega * a[j]);

    a[j] = mod(a[j] * SCALING);

    j++;
    a[j] = mod(omega2 * a[j]);

    a[j] = mod(a[j] * SCALING);
    j++;

    omega = omega * primrt;
    omega = mod(omega);
    omega2 = omega2 * primrt;
    omega2 = mod(omega2);
  }
}
void inv_ntt2copy(uint16_t a[M]) {//Inverse NTT operation with old parameters for omega
  int j, k, m;
  uint32_t u1, t1, u2, t2;
  uint32_t primrt, omega;
  primrt = 0;

  for (m = 2; m <= M / 2; m = 2 * m) {
	#pragma HLS loop_flatten
	#pragma HLS PIPELINE II=1
	#ifdef NTT512
    switch (m) {
    case 2:
      primrt = 12288;
      break;
    case 4:
      primrt = 10810;
      break;
    case 8:
      primrt = 7143;
      break;
    case 16:
      primrt = 10984;
      break;
    case 32:
      primrt = 8747;
      break;
    case 64:
      primrt = 9650;
      break;
    case 128:
      primrt = 790;
      break;
    case 256:
      primrt = 1696;
      break;
    }
	#else
    switch (m) {
    case 2:
      primrt = 7680;
      break;
    case 4:
      primrt = 4298;
      break;
    case 8:
      primrt = 1213;
      break;
    case 16:
      primrt = 7154;
      break;
    case 32:
      primrt = 6315;
      break;
    case 64:
      primrt = 2645;
      break;
    case 128:
      primrt = 5258;
      break;
    }
	#endif

    omega = 1;
    for (j = 0; j < m / 2; j++) {
    	for (k = 0; k < M / 2; k = k + m) {
			#pragma HLS PIPELINE II=1
    		t1 = omega * a[2 * (k + j) + 1];
    		t1 = mod(t1);
    		u1 = a[2 * (k + j)];
    		t2 = omega * a[2 * (k + j + m / 2) + 1];
    		t2 = mod(t2);
    		u2 = a[2 * (k + j + m / 2)];
    		a[2 * (k + j)] = mod(u1 + t1);
    		a[2 * (k + j + m / 2)] = mod(u1 - t1);
    		a[2 * (k + j) + 1] = mod(u2 + t2);
    		a[2 * (k + j + m / 2) + 1] = mod(u2 - t2);
    	}
    	omega = omega * primrt;
    	omega = mod(omega);
    }
  }
  primrt = INVCONST1;
  omega = 1;
  for (j = 0; j < M;) {
	#pragma HLS PIPELINE II=1
    u1 = a[j];
    j++;
    t1 = omega * a[j];
    t1 = mod(t1);

    a[j - 1] = mod(u1 + t1);
    a[j] = mod(u1 - t1);
    j++;

    omega = omega * primrt;
    omega = mod(omega);
  }
  uint32_t omega2 = INVCONST2;
  primrt = INVCONST3;
  omega = 1;

  for (j = 0; j < M;) {
	#pragma HLS PIPELINE II=1
    a[j] = mod(omega * a[j]);

    a[j] = mod(a[j] * SCALING);

    j++;
    a[j] = mod(omega2 * a[j]);

    a[j] = mod(a[j] * SCALING);
    j++;

    omega = omega * primrt;
    omega = mod(omega);
    omega2 = omega2 * primrt;
    omega2 = mod(omega2);
  }
}
void inv_ntt_1024points(uint16_t a[M]) {//Inverse NTT operation for n=1024 points
  int j, k, m;
  uint32_t u1, t1, u2, t2;
  uint32_t primrt, omega;
  primrt = 0;

  for (m = 2; m <= M / 2; m = 2 * m) {
	#pragma HLS loop_flatten
	#pragma HLS PIPELINE II=1
	#ifdef NTT512
    switch (m) {
    case 2:
      primrt = 12288;
      break;
    case 4:
      primrt = 10810;
      break;
    case 8:
      primrt = 7143;
      break;
    case 16:
      primrt = 10984;
      break;
    case 32:
      primrt = 8747;
      break;
    case 64:
      primrt = 9650;
      break;
    case 128:
      primrt = 790;
      break;
    case 256:
      primrt = 1696;
      break;
    case 512:
      primrt = 2859;
      break;
    }
	#else
    switch (m) {
    case 2:
      primrt = 7680;
      break;
    case 4:
      primrt = 4298;
      break;
    case 8:
      primrt = 1213;
      break;
    case 16:
      primrt = 7154;
      break;
    case 32:
      primrt = 6315;
      break;
    case 64:
      primrt = 2645;
      break;
    case 128:
      primrt = 5258;
      break;
    }
	#endif

    omega = 1;
    for (j = 0; j < m / 2; j++) {
    	for (k = 0; k < M / 2; k = k + m) {
			#pragma HLS PIPELINE II=1
    		t1 = omega * a[2 * (k + j) + 1];
    		t1 = mod(t1);
    		u1 = a[2 * (k + j)];
    		t2 = omega * a[2 * (k + j + m / 2) + 1];
    		t2 = mod(t2);
    		u2 = a[2 * (k + j + m / 2)];

    		a[2 * (k + j)] = mod(u1 + t1);
    		a[2 * (k + j + m / 2)] = mod(u1 - t1);

    		a[2 * (k + j) + 1] = mod(u2 + t2);
    		a[2 * (k + j + m / 2) + 1] = mod(u2 - t2);
    	}
    	omega = omega * primrt;
    	omega = mod(omega);
    }
  }

  primrt = INVCONST1;
  omega = 1;
  for (j = 0; j < M;) {
	#pragma HLS PIPELINE II=1
    u1 = a[j];
    j++;
    t1 = omega * a[j];
    t1 = mod(t1);

    a[j - 1] = mod(u1 + t1);
    a[j] = mod(u1 - t1);
    j++;

    omega = omega * primrt;
    omega = mod(omega);
  }
  uint32_t omega2 = INVCONST2;
  primrt = INVCONST3;
  omega = 1;

  for (j = 0; j < M;) {
	#pragma HLS PIPELINE II=1
    a[j] = mod(omega * a[j]);

    a[j] = mod(a[j] * SCALING);

    j++;
    a[j] = mod(omega2 * a[j]);

    a[j] = mod(a[j] * SCALING);
    j++;

    omega = omega * primrt;
    omega = mod(omega);
    omega2 = omega2 * primrt;
    omega2 = mod(omega2);
  }
}


void RLWE_dec2(uint16_t c1[M], uint16_t c2[M], uint16_t r2[M])
{

  coefficient_mul2(c1, c1, r2); // c1 <-- c1*r2
  coefficient_add2(c1, c1, c2); // c1 <-- c1*r2 + c2
  inv_ntt2(c1);

}
void encdec(unsigned int cond,uint16_t a[M],uint16_t c1[M],uint16_t c2[M],uint16_t m[M],uint16_t p[M],uint16_t r2[M],uint16_t arr[M]){
#pragma HLS INTERFACE m_axi port=arr offset=slave bundle=m_axi
#pragma HLS INTERFACE s_axilite port=cond bundle=S_AXI_BUNDLE
#pragma HLS INTERFACE s_axilite port=r2 bundle=S_AXI_BUNDLE
#pragma HLS INTERFACE s_axilite port=p bundle=S_AXI_BUNDLE
#pragma HLS INTERFACE s_axilite port=m bundle=S_AXI_BUNDLE
#pragma HLS INTERFACE s_axilite port=c2 bundle=S_AXI_BUNDLE
#pragma HLS INTERFACE s_axilite port=c1 bundle=S_AXI_BUNDLE
#pragma HLS INTERFACE s_axilite port=a bundle=S_AXI_BUNDLE
#pragma HLS INTERFACE s_axilite port=return bundle=S_AXI_BUNDLE
#pragma HLS INTERFACE m_axi port=return
	if(cond==1){
	RLWE_enc2(a,c1,c2,m,p);
	}
	else if(cond==0){
	RLWE_dec2(c1,c2,r2);
	}
	int i;
	for(i=0;i<M;i++){
		#pragma HLS PIPELINE II=1
		arr[i]=c1[i];

	}
}
